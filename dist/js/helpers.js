"use strict";var registerServiceWorker=function(){navigator.serviceWorker&&navigator.serviceWorker.register("/service-worker.js").catch(function(t){return console.log(t)})},cleanMapboxTilesCache=function(){caches.open("restaurant-reviews-map-tiles").then(function(n){return n.keys().then(function(t){var e=t.length;e<=12||t.slice(0,e-12).forEach(function(t){n.delete(t)})})})},openDatabase=function(t){return navigator.serviceWorker||t?idb.open("restaurant-reviews",4,function(t){switch(t.oldVersion){case 0:t.createObjectStore("restaurants",{keyPath:"id"});case 1:t.createObjectStore("reviews",{keyPath:"id"}).createIndex("restaurant_id","restaurant_id");case 2:t.createObjectStore("outbox",{keyPath:"request_id"});case 3:t.transaction.objectStore("outbox").createIndex("restaurant_id","restaurant_id")}}):Promise.resolve()};function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}var dbPromise=openDatabase(),DBHelper=function(){function s(){_classCallCheck(this,s)}return _createClass(s,null,[{key:"fetchRestaurants",value:function(){return dbPromise.then(function(n){var r="".concat(s.DATABASE_URL,"/restaurants");if(!n)return fetch(r).then(function(t){if(t.ok)return t.json();var e="Request failed. Returned status of ".concat(t.status);return Promise.reject(e)});var a=n.transaction("restaurants").objectStore("restaurants");return a.getAll().then(function(t){var e=fetch(r).then(function(t){if(t.ok)return t.clone().json().then(function(t){a=n.transaction("restaurants","readwrite").objectStore("restaurants"),t.forEach(function(t){a.put(t)})}),t.json();var e="Request failed. Returned status of ".concat(t.status);return Promise.reject(e)});return t&&0<t.length?t:e})})}},{key:"fetchRestaurantById",value:function(t,e){dbPromise.then(function(n){var r="".concat(s.DATABASE_URL,"/restaurants/").concat(t);if(!n)return fetch(r).then(function(t){if(t.ok)return t.json();var e="Request failed. Returned status of ".concat(t.status);return Promise.reject(e)});var a=n.transaction("restaurants").objectStore("restaurants");return a.get(Number.parseInt(t,10)).then(function(t){var e=fetch(r).then(function(t){if(t.ok)return t.clone().json().then(function(t){(a=n.transaction("restaurants","readwrite").objectStore("restaurants")).put(t)}),t.json();var e="Request failed. Returned status of ".concat(t.status);return Promise.reject(e)});return t||e})}).then(function(t){e(null,t)}).catch(function(t){e(t,null)})}},{key:"fetchReviewsByRestaurantId",value:function(t,e){dbPromise.then(function(n){var r="".concat(s.DATABASE_URL,"/reviews/?restaurant_id=").concat(t);if(!n)return fetch(r).then(function(t){if(t.ok)return t.json();var e="Request failed. Returned status of ".concat(t.status);return Promise.reject(e)});var a=n.transaction("reviews").objectStore("reviews");return a.index("restaurant_id").getAll(Number.parseInt(t,10)).then(function(t){var e=fetch(r).then(function(t){if(t.ok)return t.clone().json().then(function(t){a=n.transaction("reviews","readwrite").objectStore("reviews"),t.forEach(function(t){a.put(t)})}),t.json();var e="Request failed. Returned status of ".concat(t.status);return Promise.reject(e)});return t&&0<t.length?t:e})}).then(function(t){e(null,t)}).catch(function(t){e(t,null)})}},{key:"fetchRestaurantByCuisine",value:function(n,r){s.fetchRestaurants().then(function(t){var e=t.filter(function(t){return t.cuisine_type==n});r(null,e)}).catch(function(t){r(t,null)})}},{key:"fetchRestaurantByNeighborhood",value:function(n,r){s.fetchRestaurants().then(function(t){var e=t.filter(function(t){return t.neighborhood==n});r(null,e)}).catch(function(t){r(t,null)})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(n,r,a){s.fetchRestaurants().then(function(t){var e=t;"all"!=n&&(e=e.filter(function(t){return t.cuisine_type==n})),"all"!=r&&(e=e.filter(function(t){return t.neighborhood==r})),a(null,e)}).catch(function(t){a(t,null)})}},{key:"fetchNeighborhoods",value:function(e){s.fetchRestaurants().then(function(n){var r=n.map(function(t,e){return n[e].neighborhood}),t=r.filter(function(t,e){return r.indexOf(t)==e});e(null,t)}).catch(function(t){e(t,null)})}},{key:"fetchCuisines",value:function(e){s.fetchRestaurants().then(function(n){var r=n.map(function(t,e){return n[e].cuisine_type}),t=r.filter(function(t,e){return r.indexOf(t)==e});e(null,t)}).catch(function(t){e(t,null)})}},{key:"urlForRestaurant",value:function(t){return"./restaurant.html?id=".concat(t.id)}},{key:"imageUrlForRestaurant",value:function(t,e){if(e){if("small"===e.size)return!0===e.singleValue?"img/".concat(t.photograph_small_2x):"img/".concat(t.photograph_small_1x," 1x, img/").concat(t.photograph_small_2x," 2x");if("medium"===e.size)return!0===e.singleValue?"img/".concat(t.photograph_medium_2x):"img/".concat(t.photograph_medium_1x," 1x, img/").concat(t.photograph_medium_2x," 2x");if("large"===e.size&&e.wide)return"img/".concat(t.photograph_large_wide)}return"img/".concat(t.photograph_large)}},{key:"mapMarkerForRestaurant",value:function(t,e){var n=new L.marker([t.latlng.lat,t.latlng.lng],{title:t.name,alt:t.name,url:s.urlForRestaurant(t)});return n.addTo(newMap),n}},{key:"setRestaurantFavouriteStatus",value:function(t,e,n){var r="".concat(s.DATABASE_URL,"/restaurants/").concat(t,"/?is_favorite=").concat(e);fetch(r,{method:"PUT"}).then(function(t){return t.ok?t.json():Promise.reject()}).then(function(e){dbPromise.then(function(t){t.transaction("restaurants","readwrite").objectStore("restaurants").put(e)}),n(null,e)}).catch(function(t){n(t,null)})}},{key:"addReview",value:function(t,e,n,r,a){var o="".concat(s.DATABASE_URL,"/reviews"),u=JSON.stringify({restaurant_id:t,name:e,rating:n,comments:r});fetch(o,{method:"POST",body:u}).then(function(t){if(t.ok)return t.json();var e="Request failed. Returned status of ".concat(t.status);return Promise.reject(e)}).then(function(t){a(null,t)}).catch(function(t){a(t,null)})}},{key:"getOutboxReviews",value:function(e,n){dbPromise.then(function(t){if(t){t.transaction("outbox").objectStore("outbox").index("restaurant_id").getAll(Number.parseInt(e,10)).then(function(t){n(null,t)})}else{n("Error connecting to IndexedDB",null)}})}},{key:"DATABASE_URL",get:function(){return"http://localhost:".concat(1337)}}]),s}();function formatDate(t){var e=t.getDate(),n=["January","February","March","April","May","June","July","August","September","October","November","December"][t.getMonth()],r=t.getFullYear();return"".concat(n," ").concat(e,", ").concat(r)}function stringToBoolean(t){return"boolean"==typeof t?t:"true"===t}var toastTimer=null,pendingToasts=[],shouldRestartToastTimer=!1;function pauseToastTimer(){console.log("pausing timer"),clearTimeout(toastTimer),shouldRestartToastTimer=!(toastTimer=null)}function restartToastTimer(){console.log("restarting timer"),shouldRestartToastTimer&&(shouldRestartToastTimer=!1,toastTimer=setTimeout(hideToast,3e3))}function enqueueToast(t,e){console.log("enqueueing toast:",t),pendingToasts.unshift({message:t,type:e}),null===toastTimer&&showToast()}function showDummyToast(){enqueueToast("".concat(Math.random()))}function hideToast(){console.log("hiding toast"),clearTimeout(toastTimer),toastTimer=null,shouldRestartToastTimer=!1;var t=document.getElementById("toast"),e=document.getElementById("toast-text");t.classList.remove("show"),setTimeout(function(){e.setAttribute("aria-live","polite"),showToast()},0)}function showToast(){var t=pendingToasts.pop();if(t&&t.message){var e=t.message,n=t.type,r=document.getElementById("toast"),a=document.getElementById("toast-text"),o=document.getElementById("toast-icon");a.setAttribute("aria-live","polite"),a.innerHTML=e,o.className="error"===n?(r.className="toast show error","fas fa-exclamation-triangle"):"success"===n?(r.className="toast show success","fas fa-check"):(r.className="toast show","fas fa-info-circle"),clearTimeout(toastTimer),setTimeout(function(){a.setAttribute("aria-live","off")},0),toastTimer=setTimeout(hideToast,6e3)}}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN3aGVscGVyLmpzIiwiZGJoZWxwZXIuanMiLCJtaXNjaGVscGVycy5qcyIsInRvYXN0cy5qcyJdLCJuYW1lcyI6WyJyZWdpc3RlclNlcnZpY2VXb3JrZXIiLCJuYXZpZ2F0b3IiLCJzZXJ2aWNlV29ya2VyIiwicmVnaXN0ZXIiLCJjYXRjaCIsImVycm9yIiwiY29uc29sZSIsImxvZyIsImNsZWFuTWFwYm94VGlsZXNDYWNoZSIsImNhY2hlcyIsIm9wZW4iLCJ0aGVuIiwiY2FjaGUiLCJrZXlzIiwicmVxdWVzdHMiLCJsZW5ndGgiLCJzbGljZSIsImZvckVhY2giLCJyZXF1ZXN0IiwiZGVsZXRlIiwib3BlbkRhdGFiYXNlIiwicmVxdWVzdEZyb21TZXJ2aWNlV29ya2VyIiwiaWRiIiwidXBncmFkZURiIiwib2xkVmVyc2lvbiIsImNyZWF0ZU9iamVjdFN0b3JlIiwia2V5UGF0aCIsImNyZWF0ZUluZGV4IiwidHJhbnNhY3Rpb24iLCJvYmplY3RTdG9yZSIsIlByb21pc2UiLCJyZXNvbHZlIiwiZGJQcm9taXNlIiwiREJIZWxwZXIiLCJkYiIsInJlc3RhdXJhbnRzVVJMIiwiY29uY2F0IiwiREFUQUJBU0VfVVJMIiwiZmV0Y2giLCJyZXNwb25zZSIsIm9rIiwianNvbiIsInN0YXR1cyIsInJlamVjdCIsInN0b3JlIiwiZ2V0QWxsIiwiaWRiUmVzdGF1cmFudHMiLCJmZXRjaFJlc3BvbnNlIiwiY2xvbmUiLCJmZXRjaGVkUmVzdGF1cmFudHMiLCJyZXN0YXVyYW50IiwicHV0IiwiaWQiLCJjYWxsYmFjayIsInJlc3RhdXJhbnRCeUlkVVJMIiwiZ2V0IiwiTnVtYmVyIiwicGFyc2VJbnQiLCJpZGJSZXN0YXVyYW50IiwiZmV0Y2hlZFJlc3RhdXJhbnQiLCJyZXN0YXVyYW50SWQiLCJyZXZpZXdzQnlSZXN0YXVyYW50SWRVUkwiLCJpbmRleCIsImlkYlJldmlld3MiLCJmZXRjaGVkUmV2aWV3cyIsInJldmlldyIsInJldmlld3MiLCJjdWlzaW5lIiwiZmV0Y2hSZXN0YXVyYW50cyIsInJlc3RhdXJhbnRzIiwicmVzdWx0cyIsImZpbHRlciIsInIiLCJjdWlzaW5lX3R5cGUiLCJuZWlnaGJvcmhvb2QiLCJuZWlnaGJvcmhvb2RzIiwibWFwIiwidiIsImkiLCJ1bmlxdWVOZWlnaGJvcmhvb2RzIiwiaW5kZXhPZiIsImN1aXNpbmVzIiwidW5pcXVlQ3Vpc2luZXMiLCJvcHRpb25zIiwic2l6ZSIsInNpbmdsZVZhbHVlIiwicGhvdG9ncmFwaF9zbWFsbF8yeCIsInBob3RvZ3JhcGhfc21hbGxfMXgiLCJwaG90b2dyYXBoX21lZGl1bV8yeCIsInBob3RvZ3JhcGhfbWVkaXVtXzF4Iiwid2lkZSIsInBob3RvZ3JhcGhfbGFyZ2Vfd2lkZSIsInBob3RvZ3JhcGhfbGFyZ2UiLCJtYXJrZXIiLCJMIiwibGF0bG5nIiwibGF0IiwibG5nIiwidGl0bGUiLCJuYW1lIiwiYWx0IiwidXJsIiwidXJsRm9yUmVzdGF1cmFudCIsImFkZFRvIiwibmV3TWFwIiwic2V0RmF2b3VyaXRlU3RhdHVzVXJsIiwibWV0aG9kIiwidXBkYXRlZFJlc3RhdXJhbnQiLCJyYXRpbmciLCJjb21tZW50cyIsImFkZFJldmlld1VybCIsImJvZHkiLCJKU09OIiwic3RyaW5naWZ5IiwicmVzdGF1cmFudF9pZCIsIm5ld1JldmlldyIsImZvcm1hdERhdGUiLCJkYXRlIiwiZGF5IiwiZ2V0RGF0ZSIsIm1vbnRoIiwiZ2V0TW9udGgiLCJ5ZWFyIiwiZ2V0RnVsbFllYXIiLCJzdHJpbmdUb0Jvb2xlYW4iLCJzdHJpbmciLCJ0b2FzdFRpbWVyIiwicGVuZGluZ1RvYXN0cyIsInNob3VsZFJlc3RhcnRUb2FzdFRpbWVyIiwicGF1c2VUb2FzdFRpbWVyIiwiY2xlYXJUaW1lb3V0IiwicmVzdGFydFRvYXN0VGltZXIiLCJzZXRUaW1lb3V0IiwiaGlkZVRvYXN0IiwiZW5xdWV1ZVRvYXN0IiwibWVzc2FnZSIsInR5cGUiLCJ1bnNoaWZ0Iiwic2hvd1RvYXN0Iiwic2hvd0R1bW15VG9hc3QiLCJNYXRoIiwicmFuZG9tIiwidG9hc3QiLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwidG9hc3RUZXh0IiwiY2xhc3NMaXN0IiwicmVtb3ZlIiwic2V0QXR0cmlidXRlIiwicG9wIiwidG9hc3RFbGVtZW50IiwidG9hc3RJY29uIiwiaW5uZXJIVE1MIiwiY2xhc3NOYW1lIl0sIm1hcHBpbmdzIjoiYUFBQSxJQUFNQSxzQkFBd0IsV0FDdkJDLFVBQVVDLGVBRWZELFVBQVVDLGNBQWNDLFNBQVMsc0JBQzlCQyxNQUFNLFNBQUFDLEdBQUssT0FBSUMsUUFBUUMsSUFBSUYsTUFHMUJHLHNCQUF3QixXQUM1QkMsT0FBT0MsS0FBSyxnQ0FBZ0NDLEtBQzFDLFNBQUFDLEdBQUssT0FBSUEsRUFBTUMsT0FBT0YsS0FBSyxTQUFDRyxHQUFhLElBQy9CQyxFQUFXRCxFQUFYQyxPQUNKQSxHQUFVLElBR2RELEVBQVNFLE1BQU0sRUFBR0QsRUFBUyxJQUFJRSxRQUFRLFNBQUNDLEdBQ3RDTixFQUFNTyxPQUFPRCxVQVNmRSxhQUFlLFNBQUNDLEdBQ3BCLE9BQUtwQixVQUFVQyxlQUFrQm1CLEVBRTFCQyxJQUFJWixLQUFLLHFCQUFzQixFQUFHLFNBQUNhLEdBQ3hDLE9BQVFBLEVBQVVDLFlBQ2hCLEtBQUssRUFDSEQsRUFBVUUsa0JBQWtCLGNBQWUsQ0FDekNDLFFBQVMsT0FHYixLQUFLLEVBQTBCSCxFQUFVRSxrQkFBa0IsVUFBVyxDQUNwRUMsUUFBUyxPQUVFQyxZQUFZLGdCQUFpQixpQkFFMUMsS0FBSyxFQUNISixFQUFVRSxrQkFBa0IsU0FBVSxDQUNwQ0MsUUFBUyxlQUdiLEtBQUssRUFDaUJILEVBQVVLLFlBQVlDLFlBQVksVUFDMUNGLFlBQVksZ0JBQWlCLG9CQXJCbUJHLFFBQVFDLGlaQ3pCNUUsSUFBTUMsVUFBWVosZUFLWmEsOEhBY0YsT0FBT0QsVUFBVXJCLEtBQUssU0FBQ3VCLEdBQ3JCLElBQU1DLEVBQWMsR0FBQUMsT0FBTUgsRUFBU0ksYUFBZixnQkFFcEIsSUFBS0gsRUFFSCxPQUFPSSxNQUFNSCxHQUNWeEIsS0FB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LEVBQVFmLGNBQWNzQixNQUM1QixHQUFLUCxHQUFVQSxFQUFNUCxRQUFyQixDQUZtQixJQUlYQSxFQUFrQk8sRUFBbEJQLFFBQVNDLEVBQVNNLEVBQVROLEtBQ1hjLEVBQWVQLFNBQVNDLGVBQWUsU0FDdkNDLEVBQVlGLFNBQVNDLGVBQWUsY0FDcENPLEVBQVlSLFNBQVNDLGVBQWUsY0FFMUNDLEVBQVVHLGFBQWEsWUFBYSxVQUNwQ0gsRUFBVU8sVUFBWWpCLEVBSXBCZ0IsRUFBVUUsVUFGQyxVQUFUakIsR0FDRmMsRUFBYUcsVUFBWSxtQkFDSCwrQkFDSixZQUFUakIsR0FDVGMsRUFBYUcsVUFBWSxxQkFDSCxpQkFFdEJILEVBQWFHLFVBQVksYUFDSCxzQkFHeEJ2QixhQUFhSixZQUNiTSxXQUFXLFdBQ1RhLEVBQVVHLGFBQWEsWUFBYSxRQUNuQyxHQUNIdEIsV0FBYU0sV0FBV0MsVUFBVyIsImZpbGUiOiJoZWxwZXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcmVnaXN0ZXJTZXJ2aWNlV29ya2VyID0gKCkgPT4ge1xuICBpZiAoIW5hdmlnYXRvci5zZXJ2aWNlV29ya2VyKSByZXR1cm47XG5cbiAgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIucmVnaXN0ZXIoJy9zZXJ2aWNlLXdvcmtlci5qcycpXG4gICAgLmNhdGNoKGVycm9yID0+IGNvbnNvbGUubG9nKGVycm9yKSk7XG59O1xuXG5jb25zdCBjbGVhbk1hcGJveFRpbGVzQ2FjaGUgPSAoKSA9PiB7XG4gIGNhY2hlcy5vcGVuKCdyZXN0YXVyYW50LXJldmlld3MtbWFwLXRpbGVzJykudGhlbihcbiAgICBjYWNoZSA9PiBjYWNoZS5rZXlzKCkudGhlbigocmVxdWVzdHMpID0+IHtcbiAgICAgIGNvbnN0IHsgbGVuZ3RoIH0gPSByZXF1ZXN0cztcbiAgICAgIGlmIChsZW5ndGggPD0gMTIpIHJldHVybjtcblxuICAgICAgLy8ga2VlcCBvbmx5IHRoZSAxMiBtb3N0IHJlY2VudCB0aWxlc1xuICAgICAgcmVxdWVzdHMuc2xpY2UoMCwgbGVuZ3RoIC0gMTIpLmZvckVhY2goKHJlcXVlc3QpID0+IHtcbiAgICAgICAgY2FjaGUuZGVsZXRlKHJlcXVlc3QpO1xuICAgICAgfSk7XG4gICAgfSksXG4gICk7XG59O1xuXG4vKiBlc2xpbnQtZGlzYWJsZSBkZWZhdWx0LWNhc2UgKi9cbi8qIGVzbGludC1kaXNhYmxlIG5vLWZhbGx0aHJvdWdoICovXG5cbmNvbnN0IG9wZW5EYXRhYmFzZSA9IChyZXF1ZXN0RnJvbVNlcnZpY2VXb3JrZXIpID0+IHtcbiAgaWYgKCFuYXZpZ2F0b3Iuc2VydmljZVdvcmtlciAmJiAhcmVxdWVzdEZyb21TZXJ2aWNlV29ya2VyKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgcmV0dXJuIGlkYi5vcGVuKCdyZXN0YXVyYW50LXJldmlld3MnLCA0LCAodXBncmFkZURiKSA9PiB7XG4gICAgc3dpdGNoICh1cGdyYWRlRGIub2xkVmVyc2lvbikge1xuICAgICAgY2FzZSAwOiB7XG4gICAgICAgIHVwZ3JhZGVEYi5jcmVhdGVPYmplY3RTdG9yZSgncmVzdGF1cmFudHMnLCB7XG4gICAgICAgICAga2V5UGF0aDogJ2lkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBjYXNlIDE6IHsgY29uc3QgcmV2aWV3c1N0b3JlID0gdXBncmFkZURiLmNyZWF0ZU9iamVjdFN0b3JlKCdyZXZpZXdzJywge1xuICAgICAgICBrZXlQYXRoOiAnaWQnLFxuICAgICAgfSk7XG4gICAgICByZXZpZXdzU3RvcmUuY3JlYXRlSW5kZXgoJ3Jlc3RhdXJhbnRfaWQnLCAncmVzdGF1cmFudF9pZCcpO1xuICAgICAgfVxuICAgICAgY2FzZSAyOiB7XG4gICAgICAgIHVwZ3JhZGVEYi5jcmVhdGVPYmplY3RTdG9yZSgnb3V0Ym94Jywge1xuICAgICAgICAgIGtleVBhdGg6ICdyZXF1ZXN0X2lkJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBjYXNlIDM6IHtcbiAgICAgICAgY29uc3Qgb3V0Ym94U3RvcmUgPSB1cGdyYWRlRGIudHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoJ291dGJveCcpO1xuICAgICAgICBvdXRib3hTdG9yZS5jcmVhdGVJbmRleCgncmVzdGF1cmFudF9pZCcsICdyZXN0YXVyYW50X2lkJyk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbn07XG4iLCJjb25zdCBkYlByb21pc2UgPSBvcGVuRGF0YWJhc2UoKTtcblxuLyoqXG4gKiBDb21tb24gZGF0YWJhc2UgaGVscGVyIGZ1bmN0aW9ucy5cbiAqL1xuY2xhc3MgREJIZWxwZXIge1xuICAvKipcbiAgICogRGF0YWJhc2UgVVJMLlxuICAgKiBDaGFuZ2UgdGhpcyB0byByZXN0YXVyYW50cy5qc29uIGZpbGUgbG9jYXRpb24gb24geW91ciBzZXJ2ZXIuXG4gICAqL1xuICBzdGF0aWMgZ2V0IERBVEFCQVNFX1VSTCgpIHtcbiAgICBjb25zdCBwb3J0ID0gMTMzNzsgLy8gQ2hhbmdlIHRoaXMgdG8geW91ciBzZXJ2ZXIgcG9ydFxuICAgIHJldHVybiBgaHR0cDovL2xvY2FsaG9zdDoke3BvcnR9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBGZXRjaCBhbGwgcmVzdGF1cmFudHMuXG4gICAqL1xuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50cygpIHtcbiAgICByZXR1cm4gZGJQcm9taXNlLnRoZW4oKGRiKSA9PiB7XG4gICAgICBjb25zdCByZXN0YXVyYW50c1VSTCA9IGAke0RCSGVscGVyLkRBVEFCQVNFX1VSTH0vcmVzdGF1cmFudHNgO1xuXG4gICAgICBpZiAoIWRiKSB7XG4gICAgICAgIC8vIG1ha2UgcmVndWxhciBmZXRjaCBjYWxsXG4gICAgICAgIHJldHVybiBmZXRjaChyZXN0YXVyYW50c1VSTClcbiAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgICAgY29uc3QgZXJyb3IgPSAoYFJlcXVlc3QgZmFpbGVkLiBSZXR1cm5lZCBzdGF0dXMgb2YgJHtyZXNwb25zZS5zdGF0dXN9YCk7XG4gICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyByZXR1cm4gcmVzdGF1cmFudHMgZnJvbSBJREJcbiAgICAgIGxldCBzdG9yZSA9IGRiLnRyYW5zYWN0aW9uKCdyZXN0YXVyYW50cycpLm9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycpO1xuICAgICAgcmV0dXJuIHN0b3JlLmdldEFsbCgpLnRoZW4oKGlkYlJlc3RhdXJhbnRzKSA9PiB7XG4gICAgICAgIGNvbnN0IGZldGNoUmVzcG9uc2UgPSBmZXRjaChyZXN0YXVyYW50c1VSTClcbiAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgICAgY29uc3QgZXJyb3IgPSAoYFJlcXVlc3QgZmFpbGVkLiBSZXR1cm5lZCBzdGF0dXMgb2YgJHtyZXNwb25zZS5zdGF0dXN9YCk7XG4gICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZUpTT04gPSByZXNwb25zZS5jbG9uZSgpLmpzb24oKTtcbiAgICAgICAgICAgIC8vIHVwZGF0ZSBJREIgcmVzdGF1cmFudHMgd2l0aCBmZXRjaCByZXNwb25zZSBldmVuIGlmIHZhbHVlcyBmcm9tIElEQiB3aWxsIGJlIHJldHVybmVkXG4gICAgICAgICAgICByZXNwb25zZUpTT04udGhlbigoZmV0Y2hlZFJlc3RhdXJhbnRzKSA9PiB7XG4gICAgICAgICAgICAgIHN0b3JlID0gZGIudHJhbnNhY3Rpb24oJ3Jlc3RhdXJhbnRzJywgJ3JlYWR3cml0ZScpLm9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycpO1xuICAgICAgICAgICAgICBmZXRjaGVkUmVzdGF1cmFudHMuZm9yRWFjaCgocmVzdGF1cmFudCkgPT4ge1xuICAgICAgICAgICAgICAgIHN0b3JlLnB1dChyZXN0YXVyYW50KTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIGlmIChpZGJSZXN0YXVyYW50cyAmJiBpZGJSZXN0YXVyYW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgcmV0dXJuIGlkYlJlc3RhdXJhbnRzO1xuICAgICAgICB9XG4gICAgICAgIC8vIGlmIElEQi5yZXN0YXVyYW50cyBpcyBlbXB0eSwgcmV0dXJuIHRoZSBmZXRjaCByZXNwb25zZSBpbnN0ZWFkXG4gICAgICAgIHJldHVybiBmZXRjaFJlc3BvbnNlO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRmV0Y2ggYSByZXN0YXVyYW50IGJ5IGl0cyBJRC5cbiAgICovXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeUlkKGlkLCBjYWxsYmFjaykge1xuICAgIGRiUHJvbWlzZS50aGVuKChkYikgPT4ge1xuICAgICAgY29uc3QgcmVzdGF1cmFudEJ5SWRVUkwgPSBgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9L3Jlc3RhdXJhbnRzLyR7aWR9YDtcblxuICAgICAgaWYgKCFkYikge1xuICAgICAgICAvLyBtYWtlIHJlZ3VsYXIgZmV0Y2ggY2FsbFxuICAgICAgICByZXR1cm4gZmV0Y2gocmVzdGF1cmFudEJ5SWRVUkwpXG4gICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gKGBSZXF1ZXN0IGZhaWxlZC4gUmV0dXJuZWQgc3RhdHVzIG9mICR7cmVzcG9uc2Uuc3RhdHVzfWApO1xuICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gcmV0dXJuIHJlc3RhdXJhbnQgZnJvbSBJREJcbiAgICAgIGxldCBzdG9yZSA9IGRiLnRyYW5zYWN0aW9uKCdyZXN0YXVyYW50cycpLm9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycpO1xuICAgICAgLy8gaWQgY29tZXMgYXMgYSBzdHJpbmcgZnJvbSB0aGUgdXJsLCBjb252ZXJ0IHRvIGEgbnVtYmVyIGJlZm9yZSBsb29rdXBcbiAgICAgIHJldHVybiBzdG9yZS5nZXQoTnVtYmVyLnBhcnNlSW50KGlkLCAxMCkpLnRoZW4oKGlkYlJlc3RhdXJhbnQpID0+IHtcbiAgICAgICAgY29uc3QgZmV0Y2hSZXNwb25zZSA9IGZldGNoKHJlc3RhdXJhbnRCeUlkVVJMKVxuICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICAgICAgICBjb25zdCBlcnJvciA9IChgUmVxdWVzdCBmYWlsZWQuIFJldHVybmVkIHN0YXR1cyBvZiAke3Jlc3BvbnNlLnN0YXR1c31gKTtcbiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlSlNPTiA9IHJlc3BvbnNlLmNsb25lKCkuanNvbigpO1xuICAgICAgICAgICAgLy8gdXBkYXRlIElEQiByZXN0YXVyYW50cyB3aXRoIGZldGNoIHJlc3BvbnNlIGV2ZW4gaWYgdmFsdWUgZnJvbSBJREIgd2lsbCBiZSByZXR1cm5lZFxuICAgICAgICAgICAgcmVzcG9uc2VKU09OLnRoZW4oKGZldGNoZWRSZXN0YXVyYW50KSA9PiB7XG4gICAgICAgICAgICAgIHN0b3JlID0gZGIudHJhbnNhY3Rpb24oJ3Jlc3RhdXJhbnRzJywgJ3JlYWR3cml0ZScpLm9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycpO1xuICAgICAgICAgICAgICBzdG9yZS5wdXQoZmV0Y2hlZFJlc3RhdXJhbnQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gaWRiUmVzdGF1cmFudCB8fCBmZXRjaFJlc3BvbnNlO1xuICAgICAgfSk7XG4gICAgfSkudGhlbigocmVzdGF1cmFudCkgPT4geyBjYWxsYmFjayhudWxsLCByZXN0YXVyYW50KTsgfSlcbiAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHsgY2FsbGJhY2soZXJyb3IsIG51bGwpOyB9KTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIEZldGNoIHJldmlld3MgYnkgcmVzdGF1cmFudCBJRC5cbiAgICovXG4gIHN0YXRpYyBmZXRjaFJldmlld3NCeVJlc3RhdXJhbnRJZChyZXN0YXVyYW50SWQsIGNhbGxiYWNrKSB7XG4gICAgZGJQcm9taXNlLnRoZW4oKGRiKSA9PiB7XG4gICAgICBjb25zdCByZXZpZXdzQnlSZXN0YXVyYW50SWRVUkwgPSBgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9L3Jldmlld3MvP3Jlc3RhdXJhbnRfaWQ9JHtyZXN0YXVyYW50SWR9YDtcblxuICAgICAgaWYgKCFkYikge1xuICAgICAgICAvLyBtYWtlIHJlZ3VsYXIgZmV0Y2ggY2FsbFxuICAgICAgICByZXR1cm4gZmV0Y2gocmV2aWV3c0J5UmVzdGF1cmFudElkVVJMKVxuICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICAgICAgICBjb25zdCBlcnJvciA9IChgUmVxdWVzdCBmYWlsZWQuIFJldHVybmVkIHN0YXR1cyBvZiAke3Jlc3BvbnNlLnN0YXR1c31gKTtcbiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIHJldHVybiByZXZpZXdzIGZyb20gSURCXG4gICAgICBsZXQgc3RvcmUgPSBkYi50cmFuc2FjdGlvbigncmV2aWV3cycpLm9iamVjdFN0b3JlKCdyZXZpZXdzJyk7XG4gICAgICBjb25zdCByZXZpZXdzQnlSZXN0YXVyYW50SWRJbmRleCA9IHN0b3JlLmluZGV4KCdyZXN0YXVyYW50X2lkJyk7XG4gICAgICAvLyBpZCBjb21lcyBhcyBhIHN0cmluZyBmcm9tIHRoZSB1cmwsIGNvbnZlcnQgdG8gYSBudW1iZXIgYmVmb3JlIGxvb2t1cFxuICAgICAgcmV0dXJuIHJldmlld3NCeVJlc3RhdXJhbnRJZEluZGV4LmdldEFsbChOdW1iZXIucGFyc2VJbnQocmVzdGF1cmFudElkLCAxMCkpLnRoZW4oKGlkYlJldmlld3MpID0+IHtcbiAgICAgICAgY29uc3QgZmV0Y2hSZXNwb25zZSA9IGZldGNoKHJldmlld3NCeVJlc3RhdXJhbnRJZFVSTClcbiAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgICAgY29uc3QgZXJyb3IgPSAoYFJlcXVlc3QgZmFpbGVkLiBSZXR1cm5lZCBzdGF0dXMgb2YgJHtyZXNwb25zZS5zdGF0dXN9YCk7XG4gICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZUpTT04gPSByZXNwb25zZS5jbG9uZSgpLmpzb24oKTtcbiAgICAgICAgICAgIC8vIHVwZGF0ZSBJREIgcmV2aWV3cyB3aXRoIGZldGNoIHJlc3BvbnNlIGV2ZW4gaWYgdmFsdWVzIGZyb20gSURCIHdpbGwgYmUgcmV0dXJuZWRcbiAgICAgICAgICAgIHJlc3BvbnNlSlNPTi50aGVuKChmZXRjaGVkUmV2aWV3cykgPT4ge1xuICAgICAgICAgICAgICBzdG9yZSA9IGRiLnRyYW5zYWN0aW9uKCdyZXZpZXdzJywgJ3JlYWR3cml0ZScpLm9iamVjdFN0b3JlKCdyZXZpZXdzJyk7XG4gICAgICAgICAgICAgIGZldGNoZWRSZXZpZXdzLmZvckVhY2goKHJldmlldykgPT4ge1xuICAgICAgICAgICAgICAgIHN0b3JlLnB1dChyZXZpZXcpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgaWYgKGlkYlJldmlld3MgJiYgaWRiUmV2aWV3cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgcmV0dXJuIGlkYlJldmlld3M7XG4gICAgICAgIH1cbiAgICAgICAgLy8gaWYgSURCLnJldmlld3MgaXMgZW1wdHksIHJldHVybiB0aGUgZmV0Y2ggcmVzcG9uc2UgaW5zdGVhZFxuICAgICAgICByZXR1cm4gZmV0Y2hSZXNwb25zZTtcbiAgICAgIH0pO1xuICAgIH0pLnRoZW4oKHJldmlld3MpID0+IHsgY2FsbGJhY2sobnVsbCwgcmV2aWV3cyk7IH0pXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiB7IGNhbGxiYWNrKGVycm9yLCBudWxsKTsgfSk7XG4gIH1cblxuICAvKipcbiAgICogRmV0Y2ggcmVzdGF1cmFudHMgYnkgYSBjdWlzaW5lIHR5cGUgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXG4gICAqL1xuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lKGN1aXNpbmUsIGNhbGxiYWNrKSB7XG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzICB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZ1xuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKS50aGVuKChyZXN0YXVyYW50cykgPT4ge1xuICAgICAgLy8gRmlsdGVyIHJlc3RhdXJhbnRzIHRvIGhhdmUgb25seSBnaXZlbiBjdWlzaW5lIHR5cGVcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSByZXN0YXVyYW50cy5maWx0ZXIociA9PiByLmN1aXNpbmVfdHlwZSA9PSBjdWlzaW5lKTtcbiAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3VsdHMpO1xuICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxuICAgKi9cbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5TmVpZ2hib3Job29kKG5laWdoYm9yaG9vZCwgY2FsbGJhY2spIHtcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKCkudGhlbigocmVzdGF1cmFudHMpID0+IHtcbiAgICAgIC8vIEZpbHRlciByZXN0YXVyYW50cyB0byBoYXZlIG9ubHkgZ2l2ZW4gbmVpZ2hib3Job29kXG4gICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcbiAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3VsdHMpO1xuICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgY3Vpc2luZSBhbmQgYSBuZWlnaGJvcmhvb2Qgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXG4gICAqL1xuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lQW5kTmVpZ2hib3Job29kKGN1aXNpbmUsIG5laWdoYm9yaG9vZCwgY2FsbGJhY2spIHtcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKCkudGhlbigocmVzdGF1cmFudHMpID0+IHtcbiAgICAgIGxldCByZXN1bHRzID0gcmVzdGF1cmFudHM7XG4gICAgICBpZiAoY3Vpc2luZSAhPSAnYWxsJykgeyAvLyBmaWx0ZXIgYnkgY3Vpc2luZVxuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLmN1aXNpbmVfdHlwZSA9PSBjdWlzaW5lKTtcbiAgICAgIH1cbiAgICAgIGlmIChuZWlnaGJvcmhvb2QgIT0gJ2FsbCcpIHsgLy8gZmlsdGVyIGJ5IG5laWdoYm9yaG9vZFxuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLm5laWdoYm9yaG9vZCA9PSBuZWlnaGJvcmhvb2QpO1xuICAgICAgfVxuICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdWx0cyk7XG4gICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRmV0Y2ggYWxsIG5laWdoYm9yaG9vZHMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXG4gICAqL1xuICBzdGF0aWMgZmV0Y2hOZWlnaGJvcmhvb2RzKGNhbGxiYWNrKSB7XG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXG4gICAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cygpLnRoZW4oKHJlc3RhdXJhbnRzKSA9PiB7XG4gICAgICAvLyBHZXQgYWxsIG5laWdoYm9yaG9vZHMgZnJvbSBhbGwgcmVzdGF1cmFudHNcbiAgICAgIGNvbnN0IG5laWdoYm9yaG9vZHMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLm5laWdoYm9yaG9vZCk7XG4gICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcyBmcm9tIG5laWdoYm9yaG9vZHNcbiAgICAgIGNvbnN0IHVuaXF1ZU5laWdoYm9yaG9vZHMgPSBuZWlnaGJvcmhvb2RzLmZpbHRlcigodiwgaSkgPT4gbmVpZ2hib3Job29kcy5pbmRleE9mKHYpID09IGkpO1xuICAgICAgY2FsbGJhY2sobnVsbCwgdW5pcXVlTmVpZ2hib3Job29kcyk7XG4gICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRmV0Y2ggYWxsIGN1aXNpbmVzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxuICAgKi9cbiAgc3RhdGljIGZldGNoQ3Vpc2luZXMoY2FsbGJhY2spIHtcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKCkudGhlbigocmVzdGF1cmFudHMpID0+IHtcbiAgICAgIC8vIEdldCBhbGwgY3Vpc2luZXMgZnJvbSBhbGwgcmVzdGF1cmFudHNcbiAgICAgIGNvbnN0IGN1aXNpbmVzID0gcmVzdGF1cmFudHMubWFwKCh2LCBpKSA9PiByZXN0YXVyYW50c1tpXS5jdWlzaW5lX3R5cGUpO1xuICAgICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZXMgZnJvbSBjdWlzaW5lc1xuICAgICAgY29uc3QgdW5pcXVlQ3Vpc2luZXMgPSBjdWlzaW5lcy5maWx0ZXIoKHYsIGkpID0+IGN1aXNpbmVzLmluZGV4T2YodikgPT0gaSk7XG4gICAgICBjYWxsYmFjayhudWxsLCB1bmlxdWVDdWlzaW5lcyk7XG4gICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmVzdGF1cmFudCBwYWdlIFVSTC5cbiAgICovXG4gIHN0YXRpYyB1cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpIHtcbiAgICByZXR1cm4gKGAuL3Jlc3RhdXJhbnQuaHRtbD9pZD0ke3Jlc3RhdXJhbnQuaWR9YCk7XG4gIH1cblxuICAvKipcbiAgICogUmVzdGF1cmFudCBpbWFnZSBVUkwuXG4gICAqL1xuICBzdGF0aWMgaW1hZ2VVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQsIG9wdGlvbnMpIHtcbiAgICBpZiAob3B0aW9ucykge1xuICAgICAgaWYgKG9wdGlvbnMuc2l6ZSA9PT0gJ3NtYWxsJykge1xuICAgICAgICBpZiAob3B0aW9ucy5zaW5nbGVWYWx1ZSA9PT0gdHJ1ZSkgcmV0dXJuIGBpbWcvJHtyZXN0YXVyYW50LnBob3RvZ3JhcGhfc21hbGxfMnh9YDtcbiAgICAgICAgcmV0dXJuIGBpbWcvJHtyZXN0YXVyYW50LnBob3RvZ3JhcGhfc21hbGxfMXh9IDF4LCBpbWcvJHtyZXN0YXVyYW50LnBob3RvZ3JhcGhfc21hbGxfMnh9IDJ4YDtcbiAgICAgIH0gaWYgKG9wdGlvbnMuc2l6ZSA9PT0gJ21lZGl1bScpIHtcbiAgICAgICAgaWYgKG9wdGlvbnMuc2luZ2xlVmFsdWUgPT09IHRydWUpIHJldHVybiBgaW1nLyR7cmVzdGF1cmFudC5waG90b2dyYXBoX21lZGl1bV8yeH1gO1xuICAgICAgICByZXR1cm4gYGltZy8ke3Jlc3RhdXJhbnQucGhvdG9ncmFwaF9tZWRpdW1fMXh9IDF4LCBpbWcvJHtyZXN0YXVyYW50LnBob3RvZ3JhcGhfbWVkaXVtXzJ4fSAyeGA7XG4gICAgICB9IGlmIChvcHRpb25zLnNpemUgPT09ICdsYXJnZScgJiYgb3B0aW9ucy53aWRlKSB7XG4gICAgICAgIHJldHVybiBgaW1nLyR7cmVzdGF1cmFudC5waG90b2dyYXBoX2xhcmdlX3dpZGV9YDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIChgaW1nLyR7cmVzdGF1cmFudC5waG90b2dyYXBoX2xhcmdlfWApO1xuICB9XG5cbiAgLyoqXG4gICAqIE1hcCBtYXJrZXIgZm9yIGEgcmVzdGF1cmFudC5cbiAgICovXG4gIHN0YXRpYyBtYXBNYXJrZXJGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQsIG1hcCkge1xuICAgIC8vIGh0dHBzOi8vbGVhZmxldGpzLmNvbS9yZWZlcmVuY2UtMS4zLjAuaHRtbCNtYXJrZXJcbiAgICBjb25zdCBtYXJrZXIgPSBuZXcgTC5tYXJrZXIoW3Jlc3RhdXJhbnQubGF0bG5nLmxhdCwgcmVzdGF1cmFudC5sYXRsbmcubG5nXSxcbiAgICAgIHtcbiAgICAgICAgdGl0bGU6IHJlc3RhdXJhbnQubmFtZSxcbiAgICAgICAgYWx0OiByZXN0YXVyYW50Lm5hbWUsXG4gICAgICAgIHVybDogREJIZWxwZXIudXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSxcbiAgICAgIH0pO1xuICAgIG1hcmtlci5hZGRUbyhuZXdNYXApO1xuICAgIHJldHVybiBtYXJrZXI7XG4gIH1cblxuICBzdGF0aWMgc2V0UmVzdGF1cmFudEZhdm91cml0ZVN0YXR1cyhyZXN0YXVyYW50SWQsIHN0YXR1cywgY2FsbGJhY2spIHtcbiAgICBjb25zdCBzZXRGYXZvdXJpdGVTdGF0dXNVcmwgPSBgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9L3Jlc3RhdXJhbnRzLyR7cmVzdGF1cmFudElkfS8/aXNfZmF2b3JpdGU9JHtzdGF0dXN9YDtcbiAgICBmZXRjaChzZXRGYXZvdXJpdGVTdGF0dXNVcmwsIHsgbWV0aG9kOiAnUFVUJyB9KS50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgfSkudGhlbigodXBkYXRlZFJlc3RhdXJhbnQpID0+IHtcbiAgICAgIGRiUHJvbWlzZS50aGVuKChkYikgPT4ge1xuICAgICAgICBjb25zdCBzdG9yZSA9IGRiLnRyYW5zYWN0aW9uKCdyZXN0YXVyYW50cycsICdyZWFkd3JpdGUnKS5vYmplY3RTdG9yZSgncmVzdGF1cmFudHMnKTtcbiAgICAgICAgc3RvcmUucHV0KHVwZGF0ZWRSZXN0YXVyYW50KTtcbiAgICAgIH0pO1xuICAgICAgY2FsbGJhY2sobnVsbCwgdXBkYXRlZFJlc3RhdXJhbnQpO1xuICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xuICAgIH0pO1xuICB9XG5cbiAgc3RhdGljIGFkZFJldmlldyhyZXN0YXVyYW50SWQsIG5hbWUsIHJhdGluZywgY29tbWVudHMsIGNhbGxiYWNrKSB7XG4gICAgY29uc3QgYWRkUmV2aWV3VXJsID0gYCR7REJIZWxwZXIuREFUQUJBU0VfVVJMfS9yZXZpZXdzYDtcbiAgICBjb25zdCBib2R5ID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgcmVzdGF1cmFudF9pZDogcmVzdGF1cmFudElkLFxuICAgICAgbmFtZSxcbiAgICAgIHJhdGluZyxcbiAgICAgIGNvbW1lbnRzLFxuICAgIH0pO1xuICAgIGZldGNoKGFkZFJldmlld1VybCwgeyBtZXRob2Q6ICdQT1NUJywgYm9keSB9KS50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICBjb25zdCBlcnJvciA9IChgUmVxdWVzdCBmYWlsZWQuIFJldHVybmVkIHN0YXR1cyBvZiAke3Jlc3BvbnNlLnN0YXR1c31gKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgfSkudGhlbigobmV3UmV2aWV3KSA9PiB7XG4gICAgICBjYWxsYmFjayhudWxsLCBuZXdSZXZpZXcpO1xuICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xuICAgIH0pO1xuICB9XG5cbiAgc3RhdGljIGdldE91dGJveFJldmlld3MocmVzdGF1cmFudElkLCBjYWxsYmFjaykge1xuICAgIGRiUHJvbWlzZS50aGVuKChkYikgPT4ge1xuICAgICAgaWYgKCFkYikge1xuICAgICAgICBjb25zdCBlcnJvciA9ICdFcnJvciBjb25uZWN0aW5nIHRvIEluZGV4ZWREQic7XG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3Qgc3RvcmUgPSBkYi50cmFuc2FjdGlvbignb3V0Ym94Jykub2JqZWN0U3RvcmUoJ291dGJveCcpO1xuICAgICAgY29uc3QgcmV2aWV3c0J5UmVzdGF1cmFudElkSW5kZXggPSBzdG9yZS5pbmRleCgncmVzdGF1cmFudF9pZCcpO1xuICAgICAgLy8gaWQgY29tZXMgYXMgYSBzdHJpbmcgZnJvbSB0aGUgdXJsLCBjb252ZXJ0IHRvIGEgbnVtYmVyIGJlZm9yZSBsb29rdXBcbiAgICAgIHJldmlld3NCeVJlc3RhdXJhbnRJZEluZGV4LmdldEFsbChOdW1iZXIucGFyc2VJbnQocmVzdGF1cmFudElkLCAxMCkpLnRoZW4oKGlkYlJldmlld3MpID0+IHtcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgaWRiUmV2aWV3cyk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuIiwiLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzU1MjQ2MS9ob3ctdG8tZm9ybWF0LWEtamF2YXNjcmlwdC1kYXRlXG5mdW5jdGlvbiBmb3JtYXREYXRlKGRhdGUpIHtcbiAgY29uc3QgbW9udGhOYW1lcyA9IFtcbiAgICAnSmFudWFyeScsICdGZWJydWFyeScsICdNYXJjaCcsXG4gICAgJ0FwcmlsJywgJ01heScsICdKdW5lJywgJ0p1bHknLFxuICAgICdBdWd1c3QnLCAnU2VwdGVtYmVyJywgJ09jdG9iZXInLFxuICAgICdOb3ZlbWJlcicsICdEZWNlbWJlcicsXG4gIF07XG5cbiAgY29uc3QgZGF5ID0gZGF0ZS5nZXREYXRlKCk7XG4gIGNvbnN0IG1vbnRoID0gbW9udGhOYW1lc1tkYXRlLmdldE1vbnRoKCldO1xuICBjb25zdCB5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpO1xuXG4gIHJldHVybiBgJHttb250aH0gJHtkYXl9LCAke3llYXJ9YDtcbn1cblxuZnVuY3Rpb24gc3RyaW5nVG9Cb29sZWFuKHN0cmluZykge1xuICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ2Jvb2xlYW4nKSByZXR1cm4gc3RyaW5nO1xuXG4gIHJldHVybiBzdHJpbmcgPT09ICd0cnVlJztcbn1cbiIsImxldCB0b2FzdFRpbWVyID0gbnVsbDtcbmNvbnN0IHBlbmRpbmdUb2FzdHMgPSBbXTtcbmxldCBzaG91bGRSZXN0YXJ0VG9hc3RUaW1lciA9IGZhbHNlO1xuXG5mdW5jdGlvbiBwYXVzZVRvYXN0VGltZXIoKSB7XG4gIGNvbnNvbGUubG9nKCdwYXVzaW5nIHRpbWVyJyk7XG4gIGNsZWFyVGltZW91dCh0b2FzdFRpbWVyKTtcbiAgdG9hc3RUaW1lciA9IG51bGw7XG4gIHNob3VsZFJlc3RhcnRUb2FzdFRpbWVyID0gdHJ1ZTtcbn1cblxuZnVuY3Rpb24gcmVzdGFydFRvYXN0VGltZXIoKSB7XG4gIGNvbnNvbGUubG9nKCdyZXN0YXJ0aW5nIHRpbWVyJyk7XG4gIGlmIChzaG91bGRSZXN0YXJ0VG9hc3RUaW1lcikge1xuICAgIHNob3VsZFJlc3RhcnRUb2FzdFRpbWVyID0gZmFsc2U7XG4gICAgdG9hc3RUaW1lciA9IHNldFRpbWVvdXQoaGlkZVRvYXN0LCAzMDAwKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBlbnF1ZXVlVG9hc3QobWVzc2FnZSwgdHlwZSkge1xuICBjb25zb2xlLmxvZygnZW5xdWV1ZWluZyB0b2FzdDonLCBtZXNzYWdlKTtcbiAgLy8gYWRkIHRoZSB0b2FzdCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBhcnJheSAocXVldWUpXG4gIHBlbmRpbmdUb2FzdHMudW5zaGlmdCh7IG1lc3NhZ2UsIHR5cGUgfSk7XG4gIGlmICh0b2FzdFRpbWVyID09PSBudWxsKSB7IC8vIG5vIHRvYXN0IGlzIGN1cnJlbnRseSBzaG93aW5nXG4gICAgc2hvd1RvYXN0KCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gc2hvd0R1bW15VG9hc3QoKSB7XG4gIGNvbnN0IHN0ciA9IGAke01hdGgucmFuZG9tKCl9YDtcbiAgZW5xdWV1ZVRvYXN0KHN0cik7XG59XG5cbmZ1bmN0aW9uIGhpZGVUb2FzdCgpIHtcbiAgY29uc29sZS5sb2coJ2hpZGluZyB0b2FzdCcpO1xuICBjbGVhclRpbWVvdXQodG9hc3RUaW1lcik7XG4gIHRvYXN0VGltZXIgPSBudWxsO1xuICBzaG91bGRSZXN0YXJ0VG9hc3RUaW1lciA9IGZhbHNlO1xuICBjb25zdCB0b2FzdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b2FzdCcpO1xuICBjb25zdCB0b2FzdFRleHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9hc3QtdGV4dCcpO1xuICB0b2FzdC5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7XG4gIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgIHRvYXN0VGV4dC5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGl2ZScsICdwb2xpdGUnKTtcbiAgICAvLyBzaG93IHRoZSBuZXh0IHRvYXN0IGlmIHRoZXJlIGlzIGFueSBwZW5kaW5nXG4gICAgc2hvd1RvYXN0KCk7XG4gIH0sIDApO1xufVxuXG5mdW5jdGlvbiBzaG93VG9hc3QoKSB7XG4gIGNvbnN0IHRvYXN0ID0gcGVuZGluZ1RvYXN0cy5wb3AoKTtcbiAgaWYgKCF0b2FzdCB8fCAhdG9hc3QubWVzc2FnZSkgcmV0dXJuO1xuXG4gIGNvbnN0IHsgbWVzc2FnZSwgdHlwZSB9ID0gdG9hc3Q7XG4gIGNvbnN0IHRvYXN0RWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b2FzdCcpO1xuICBjb25zdCB0b2FzdFRleHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9hc3QtdGV4dCcpO1xuICBjb25zdCB0b2FzdEljb24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9hc3QtaWNvbicpO1xuXG4gIHRvYXN0VGV4dC5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGl2ZScsICdwb2xpdGUnKTtcbiAgdG9hc3RUZXh0LmlubmVySFRNTCA9IG1lc3NhZ2U7XG5cbiAgaWYgKHR5cGUgPT09ICdlcnJvcicpIHtcbiAgICB0b2FzdEVsZW1lbnQuY2xhc3NOYW1lID0gJ3RvYXN0IHNob3cgZXJyb3InO1xuICAgIHRvYXN0SWNvbi5jbGFzc05hbWUgPSAnZmFzIGZhLWV4Y2xhbWF0aW9uLXRyaWFuZ2xlJztcbiAgfSBlbHNlIGlmICh0eXBlID09PSAnc3VjY2VzcycpIHtcbiAgICB0b2FzdEVsZW1lbnQuY2xhc3NOYW1lID0gJ3RvYXN0IHNob3cgc3VjY2Vzcyc7XG4gICAgdG9hc3RJY29uLmNsYXNzTmFtZSA9ICdmYXMgZmEtY2hlY2snO1xuICB9IGVsc2Uge1xuICAgIHRvYXN0RWxlbWVudC5jbGFzc05hbWUgPSAndG9hc3Qgc2hvdyc7XG4gICAgdG9hc3RJY29uLmNsYXNzTmFtZSA9ICdmYXMgZmEtaW5mby1jaXJjbGUnO1xuICB9XG5cbiAgY2xlYXJUaW1lb3V0KHRvYXN0VGltZXIpO1xuICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICB0b2FzdFRleHQuc2V0QXR0cmlidXRlKCdhcmlhLWxpdmUnLCAnb2ZmJyk7XG4gIH0sIDApO1xuICB0b2FzdFRpbWVyID0gc2V0VGltZW91dChoaWRlVG9hc3QsIDYwMDApO1xufVxuIl19
