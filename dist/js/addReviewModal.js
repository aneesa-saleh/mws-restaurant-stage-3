"use strict";

/** **** modal ****** */
var previouslyFocusedElement;

function openModal() {
  previouslyFocusedElement = document.activeElement;
  var overlay = document.querySelector('.overlay');
  var interactiveElements = overlay.querySelectorAll('button, input, textarea');
  overlay.classList.add('show');
  document.body.classList.add('has-open-modal');
  document.addEventListener('keydown', trapTabKey); // focus the first element in the overlay. timeout is needed because of CSS transition

  setTimeout(function () {
    interactiveElements[0].focus();
  }, 100);
}

function closeModal() {
  clearFormErrors();
  document.querySelector('.overlay').classList.remove('show');
  document.body.classList.remove('has-open-modal');
  document.removeEventListener('keydown', trapTabKey);

  if (previouslyFocusedElement) {
    previouslyFocusedElement.focus();
  }
}

function trapTabKey(event) {
  var overlay = document.querySelector('.overlay');
  var interactiveElements = overlay.querySelectorAll('button, input');
  var TAB = 9;
  var firstElement = interactiveElements[0];
  var lastElement = interactiveElements[interactiveElements.length - 1];

  if (event.keyCode === TAB) {
    if (event.shiftKey && event.target === firstElement) {
      // shift + tab
      event.preventDefault();
      lastElement.focus();
    } else if (!event.shiftKey && event.target === lastElement) {
      // tab
      event.preventDefault();
      firstElement.focus();
    }
  }
}
/** **** handle errors ****** */


function setNameInputError() {
  var nameInput = document.getElementById('name');
  var nameInputError = document.getElementById('name-error');
  nameInput.classList.add('has-error');
  nameInput.setAttribute('aria-invalid', 'true');
  nameInput.setAttribute('aria-describedby', 'name-error');
  nameInputError.classList.add('show');
}

function clearNameInputError() {
  var nameInput = document.getElementById('name');
  var nameInputError = document.getElementById('name-error');
  nameInput.classList.remove('has-error');
  nameInput.removeAttribute('aria-invalid');
  nameInput.removeAttribute('aria-describedby');
  nameInputError.classList.remove('show');
}

function setRatingInputError() {
  var ratingInput = document.getElementById('rating');
  var ratingInputError = document.getElementById('rating-error');
  ratingInput.classList.add('has-error');
  ratingInput.setAttribute('aria-invalid', 'true');
  ratingInput.setAttribute('aria-describedby', 'rating-error');
  ratingInputError.classList.add('show');
}

function clearRatingInputError() {
  var ratingInput = document.getElementById('rating');
  var ratingInputError = document.getElementById('rating-error');
  ratingInput.classList.remove('has-error');
  ratingInput.removeAttribute('aria-invalid');
  ratingInput.removeAttribute('aria-describedby');
  ratingInputError.classList.remove('show');
}

function setCommentInputError() {
  var commentInput = document.getElementById('comments');
  var commentInputError = document.getElementById('comments-error');
  commentInput.classList.add('has-error');
  commentInput.setAttribute('aria-invalid', 'true');
  commentInput.setAttribute('aria-describedby', 'comments-error');
  commentInputError.classList.add('show');
}

function clearCommentInputError() {
  var commentInput = document.getElementById('comments');
  var commentInputError = document.getElementById('comments-error');
  commentInput.classList.remove('has-error');
  commentInput.removeAttribute('aria-invalid');
  commentInput.removeAttribute('aria-describedby');
  commentInputError.classList.remove('show');
}

var errorFunctions = {
  name: {
    setError: setNameInputError,
    clearError: clearNameInputError
  },
  rating: {
    setError: setRatingInputError,
    clearError: clearRatingInputError
  },
  comments: {
    setError: setCommentInputError,
    clearError: clearCommentInputError
  }
};
/** **** validation ****** */

function validateInput(id, value) {
  var input = document.getElementById(id).cloneNode();
  var inputValue;

  if (value !== undefined) {
    inputValue = value;
  } else {
    inputValue = input.value;
  }

  inputValue = id === 'rating' ? Number.parseInt(inputValue, 10) : inputValue;

  if (inputValue) {
    errorFunctions[id].clearError();
    return true;
  }

  errorFunctions[id].setError();
  return false;
}

function validateAllInputs() {
  var error = false;
  var inputIds = ['name', 'rating', 'comments'];
  var invalidInputs = [];
  inputIds.forEach(function (id) {
    var inputValid = validateInput(id);

    if (!inputValid) {
      invalidInputs.push(id);
      error = true;
    }
  });
  return {
    error: error,
    invalidInputs: invalidInputs
  };
}
/** **** handle events ****** */


function handleRangeChange(event) {
  var ratingValue = document.querySelector('.rating-value');
  ratingValue.innerHTML = "".concat(event.target.value, ".0");
  validateInput(event.target.name, event.target.value);
}

function handleInputKeyUp(event) {
  if (!(event.keyCode === 9)) {
    // Tab key
    validateInput(event.target.name, event.target.value);
  }
}

function handleInputBlur(event) {
  validateInput(event.target.name, event.target.value);
}

function getFormInputValues() {
  var inputIds = ['name', 'rating', 'comments'];
  var values = {};
  inputIds.forEach(function (id) {
    values[id] = document.getElementById(id).value;
  });
  return values;
}

function clearForm() {
  document.getElementById('name').value = '';
  document.getElementById('rating').value = '0';
  document.querySelector('.rating-value').innerHTML = '0.0';
  document.getElementById('comments').value = '';
}

function clearFormErrors() {
  document.getElementById('name-error').classList.remove('show');
  document.getElementById('rating-error').classList.remove('show');
  document.getElementById('comments-error').classList.remove('show');
  document.getElementById('add-review-form-error').classList.remove('show');
  document.getElementById('name').classList.remove('has-error');
  document.getElementById('rating').classList.remove('has-error');
  document.getElementById('comments').classList.remove('has-error');
}

function handleAddReviewSubmit() {
  var _validateAllInputs = validateAllInputs(),
      error = _validateAllInputs.error,
      invalidInputs = _validateAllInputs.invalidInputs;

  if (!error) {
    var _getFormInputValues = getFormInputValues(),
        name = _getFormInputValues.name,
        rating = _getFormInputValues.rating,
        comments = _getFormInputValues.comments;

    if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
      // perform regular fetch and regular updates
      var submitButton = document.getElementById('add-review-submit');
      submitButton.setAttribute('disabled', true);
      submitButton.setAttribute('aria-busy', 'true');
      DBHelper.addReview(self.restaurant.id, name, rating, comments, function (error, newReview) {
        submitButton.removeAttribute('disabled');
        submitButton.setAttribute('aria-busy', 'false');

        if (error) {
          enqueueToast('An error occurred. Please try again', 'error');
          console.log(error);
        } else {
          enqueueToast("".concat(name, "'s review has been saved"), 'success');
          var ul = document.getElementById('reviews-list');
          ul.insertBefore(createReviewHTML(newReview), ul.firstChild);
          closeModal();
          clearForm();
        }
      });
    } else {
      var requestId = "".concat(self.restaurant.id, "-").concat(Date.now());
      var newReview = {
        name: name,
        rating: rating,
        comments: comments,
        restaurant_id: self.restaurant.id
      };
      var ul = document.getElementById('reviews-list');
      ul.insertBefore(createReviewHTML(newReview, true, requestId), ul.firstChild);

      if ('onLine' in navigator && !navigator.onLine) {
        enqueueToast('Your review will be submitted when you are back online');
      }

      closeModal();
      clearForm();
      navigator.serviceWorker.controller.postMessage({
        type: 'post-review',
        review: newReview,
        requestId: requestId
      });
    }
  } else {
    // form errors not cleared
    var formError = document.getElementById('add-review-form-error');
    var errorText = "Invalid input for: ".concat(invalidInputs.join(', '));
    formError.innerHTML = errorText;
    formError.classList.add('show');
    document.getElementById(invalidInputs[0]).focus();
  }
}

function logEvent(event) {
  console.log(event.target.value);
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFkZFJldmlld01vZGFsLmpzIl0sIm5hbWVzIjpbInByZXZpb3VzbHlGb2N1c2VkRWxlbWVudCIsIm9wZW5Nb2RhbCIsImRvY3VtZW50IiwiYWN0aXZlRWxlbWVudCIsIm92ZXJsYXkiLCJxdWVyeVNlbGVjdG9yIiwiaW50ZXJhY3RpdmVFbGVtZW50cyIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJjbGFzc0xpc3QiLCJhZGQiLCJib2R5IiwiYWRkRXZlbnRMaXN0ZW5lciIsInRyYXBUYWJLZXkiLCJzZXRUaW1lb3V0IiwiZm9jdXMiLCJjbG9zZU1vZGFsIiwiY2xlYXJGb3JtRXJyb3JzIiwicmVtb3ZlIiwicmVtb3ZlRXZlbnRMaXN0ZW5lciIsImV2ZW50IiwiVEFCIiwiZmlyc3RFbGVtZW50IiwibGFzdEVsZW1lbnQiLCJsZW5ndGgiLCJrZXlDb2RlIiwic2hpZnRLZXkiLCJ0YXJnZXQiLCJwcmV2ZW50RGVmYXVsdCIsInNldE5hbWVJbnB1dEVycm9yIiwibmFtZUlucHV0IiwiZ2V0RWxlbWVudEJ5SWQiLCJuYW1lSW5wdXRFcnJvciIsInNldEF0dHJpYnV0ZSIsImNsZWFyTmFtZUlucHV0RXJyb3IiLCJyZW1vdmVBdHRyaWJ1dGUiLCJzZXRSYXRpbmdJbnB1dEVycm9yIiwicmF0aW5nSW5wdXQiLCJyYXRpbmdJbnB1dEVycm9yIiwiY2xlYXJSYXRpbmdJbnB1dEVycm9yIiwic2V0Q29tbWVudElucHV0RXJyb3IiLCJjb21tZW50SW5wdXQiLCJjb21tZW50SW5wdXRFcnJvciIsImNsZWFyQ29tbWVudElucHV0RXJyb3IiLCJlcnJvckZ1bmN0aW9ucyIsIm5hbWUiLCJzZXRFcnJvciIsImNsZWFyRXJyb3IiLCJyYXRpbmciLCJjb21tZW50cyIsInZhbGlkYXRlSW5wdXQiLCJpZCIsInZhbHVlIiwiaW5wdXQiLCJjbG9uZU5vZGUiLCJpbnB1dFZhbHVlIiwidW5kZWZpbmVkIiwiTnVtYmVyIiwicGFyc2VJbnQiLCJ2YWxpZGF0ZUFsbElucHV0cyIsImVycm9yIiwiaW5wdXRJZHMiLCJpbnZhbGlkSW5wdXRzIiwiZm9yRWFjaCIsImlucHV0VmFsaWQiLCJwdXNoIiwiaGFuZGxlUmFuZ2VDaGFuZ2UiLCJyYXRpbmdWYWx1ZSIsImlubmVySFRNTCIsImhhbmRsZUlucHV0S2V5VXAiLCJoYW5kbGVJbnB1dEJsdXIiLCJnZXRGb3JtSW5wdXRWYWx1ZXMiLCJ2YWx1ZXMiLCJjbGVhckZvcm0iLCJoYW5kbGVBZGRSZXZpZXdTdWJtaXQiLCJuYXZpZ2F0b3IiLCJzZXJ2aWNlV29ya2VyIiwiY29udHJvbGxlciIsInN1Ym1pdEJ1dHRvbiIsIkRCSGVscGVyIiwiYWRkUmV2aWV3Iiwic2VsZiIsInJlc3RhdXJhbnQiLCJuZXdSZXZpZXciLCJlbnF1ZXVlVG9hc3QiLCJjb25zb2xlIiwibG9nIiwidWwiLCJpbnNlcnRCZWZvcmUiLCJjcmVhdGVSZXZpZXdIVE1MIiwiZmlyc3RDaGlsZCIsInJlcXVlc3RJZCIsIkRhdGUiLCJub3ciLCJyZXN0YXVyYW50X2lkIiwib25MaW5lIiwicG9zdE1lc3NhZ2UiLCJ0eXBlIiwicmV2aWV3IiwiZm9ybUVycm9yIiwiZXJyb3JUZXh0Iiwiam9pbiIsImxvZ0V2ZW50Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBRUEsSUFBSUEsd0JBQUo7O0FBRUEsU0FBU0MsU0FBVCxHQUFxQjtBQUNuQkQsRUFBQUEsd0JBQXdCLEdBQUdFLFFBQVEsQ0FBQ0MsYUFBcEM7QUFDQSxNQUFNQyxPQUFPLEdBQUdGLFFBQVEsQ0FBQ0csYUFBVCxDQUF1QixVQUF2QixDQUFoQjtBQUNBLE1BQU1DLG1CQUFtQixHQUFHRixPQUFPLENBQUNHLGdCQUFSLENBQXlCLHlCQUF6QixDQUE1QjtBQUNBSCxFQUFBQSxPQUFPLENBQUNJLFNBQVIsQ0FBa0JDLEdBQWxCLENBQXNCLE1BQXRCO0FBQ0FQLEVBQUFBLFFBQVEsQ0FBQ1EsSUFBVCxDQUFjRixTQUFkLENBQXdCQyxHQUF4QixDQUE0QixnQkFBNUI7QUFDQVAsRUFBQUEsUUFBUSxDQUFDUyxnQkFBVCxDQUEwQixTQUExQixF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QVEsQ0FBQzRCLGNBQVQsQ0FBd0IsdUJBQXhCLENBQWxCO0FBQ0EsUUFBTXFFLFNBQVMsZ0NBQXlCdEMsYUFBYSxDQUFDdUMsSUFBZCxDQUFtQixJQUFuQixDQUF6QixDQUFmO0FBQ0FGLElBQUFBLFNBQVMsQ0FBQy9CLFNBQVYsR0FBc0JnQyxTQUF0QjtBQUNBRCxJQUFBQSxTQUFTLENBQUMxRixTQUFWLENBQW9CQyxHQUFwQixDQUF3QixNQUF4QjtBQUNBUCxJQUFBQSxRQUFRLENBQUM0QixjQUFULENBQXdCK0IsYUFBYSxDQUFDLENBQUQsQ0FBckMsRUFBMEMvQyxLQUExQztBQUNEO0FBQ0Y7O0FBRUQsU0FBU3VGLFFBQVQsQ0FBa0JsRixLQUFsQixFQUF5QjtBQUN2QmlFLEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZbEUsS0FBSyxDQUFDTyxNQUFOLENBQWF5QixLQUF6QjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqICoqKiogbW9kYWwgKioqKioqICovXG5cbmxldCBwcmV2aW91c2x5Rm9jdXNlZEVsZW1lbnQ7XG5cbmZ1bmN0aW9uIG9wZW5Nb2RhbCgpIHtcbiAgcHJldmlvdXNseUZvY3VzZWRFbGVtZW50ID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcbiAgY29uc3Qgb3ZlcmxheSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5vdmVybGF5Jyk7XG4gIGNvbnN0IGludGVyYWN0aXZlRWxlbWVudHMgPSBvdmVybGF5LnF1ZXJ5U2VsZWN0b3JBbGwoJ2J1dHRvbiwgaW5wdXQsIHRleHRhcmVhJyk7XG4gIG92ZXJsYXkuY2xhc3NMaXN0LmFkZCgnc2hvdycpO1xuICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ2hhcy1vcGVuLW1vZGFsJyk7XG4gIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0cmFwVGFiS2V5KTtcbiAgLy8gZm9jdXMgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIG92ZXJsYXkuIHRpbWVvdXQgaXMgbmVlZGVkIGJlY2F1c2Ugb2YgQ1NTIHRyYW5zaXRpb25cbiAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgaW50ZXJhY3RpdmVFbGVtZW50c1swXS5mb2N1cygpO1xuICB9LCAxMDApO1xufVxuXG5mdW5jdGlvbiBjbG9zZU1vZGFsKCkge1xuICBjbGVhckZvcm1FcnJvcnMoKTtcbiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm92ZXJsYXknKS5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7XG4gIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnaGFzLW9wZW4tbW9kYWwnKTtcbiAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRyYXBUYWJLZXkpO1xuICBpZiAocHJldmlvdXNseUZvY3VzZWRFbGVtZW50KSB7XG4gICAgcHJldmlvdXNseUZvY3VzZWRFbGVtZW50LmZvY3VzKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gdHJhcFRhYktleShldmVudCkge1xuICBjb25zdCBvdmVybGF5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm92ZXJsYXknKTtcbiAgY29uc3QgaW50ZXJhY3RpdmVFbGVtZW50cyA9IG92ZXJsYXkucXVlcnlTZWxlY3RvckFsbCgnYnV0dG9uLCBpbnB1dCcpO1xuICBjb25zdCBUQUIgPSA5O1xuICBjb25zdCBmaXJzdEVsZW1lbnQgPSBpbnRlcmFjdGl2ZUVsZW1lbnRzWzBdO1xuICBjb25zdCBsYXN0RWxlbWVudCA9IGludGVyYWN0aXZlRWxlbWVudHNbaW50ZXJhY3RpdmVFbGVtZW50cy5sZW5ndGggLSAxXTtcbiAgaWYgKGV2ZW50LmtleUNvZGUgPT09IFRBQikge1xuICAgIGlmIChldmVudC5zaGlmdEtleSAmJiBldmVudC50YXJnZXQgPT09IGZpcnN0RWxlbWVudCkgeyAvLyBzaGlmdCArIHRhYlxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGxhc3RFbGVtZW50LmZvY3VzKCk7XG4gICAgfSBlbHNlIGlmICghZXZlbnQuc2hpZnRLZXkgJiYgZXZlbnQudGFyZ2V0ID09PSBsYXN0RWxlbWVudCkgeyAvLyB0YWJcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBmaXJzdEVsZW1lbnQuZm9jdXMoKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqICoqKiogaGFuZGxlIGVycm9ycyAqKioqKiogKi9cblxuZnVuY3Rpb24gc2V0TmFtZUlucHV0RXJyb3IoKSB7XG4gIGNvbnN0IG5hbWVJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduYW1lJyk7XG4gIGNvbnN0IG5hbWVJbnB1dEVycm9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25hbWUtZXJyb3InKTtcbiAgbmFtZUlucHV0LmNsYXNzTGlzdC5hZGQoJ2hhcy1lcnJvcicpO1xuICBuYW1lSW5wdXQuc2V0QXR0cmlidXRlKCdhcmlhLWludmFsaWQnLCAndHJ1ZScpO1xuICBuYW1lSW5wdXQuc2V0QXR0cmlidXRlKCdhcmlhLWRlc2NyaWJlZGJ5JywgJ25hbWUtZXJyb3InKTtcbiAgbmFtZUlucHV0RXJyb3IuY2xhc3NMaXN0LmFkZCgnc2hvdycpO1xufVxuXG5mdW5jdGlvbiBjbGVhck5hbWVJbnB1dEVycm9yKCkge1xuICBjb25zdCBuYW1lSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbmFtZScpO1xuICBjb25zdCBuYW1lSW5wdXRFcnJvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduYW1lLWVycm9yJyk7XG4gIG5hbWVJbnB1dC5jbGFzc0xpc3QucmVtb3ZlKCdoYXMtZXJyb3InKTtcbiAgbmFtZUlucHV0LnJlbW92ZUF0dHJpYnV0ZSgnYXJpYS1pbnZhbGlkJyk7XG4gIG5hbWVJbnB1dC5yZW1vdmVBdHRyaWJ1dGUoJ2FyaWEtZGVzY3JpYmVkYnknKTtcbiAgbmFtZUlucHV0RXJyb3IuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpO1xufVxuXG5mdW5jdGlvbiBzZXRSYXRpbmdJbnB1dEVycm9yKCkge1xuICBjb25zdCByYXRpbmdJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyYXRpbmcnKTtcbiAgY29uc3QgcmF0aW5nSW5wdXRFcnJvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyYXRpbmctZXJyb3InKTtcbiAgcmF0aW5nSW5wdXQuY2xhc3NMaXN0LmFkZCgnaGFzLWVycm9yJyk7XG4gIHJhdGluZ0lucHV0LnNldEF0dHJpYnV0ZSgnYXJpYS1pbnZhbGlkJywgJ3RydWUnKTtcbiAgcmF0aW5nSW5wdXQuc2V0QXR0cmlidXRlKCdhcmlhLWRlc2NyaWJlZGJ5JywgJ3JhdGluZy1lcnJvcicpO1xuICByYXRpbmdJbnB1dEVycm9yLmNsYXNzTGlzdC5hZGQoJ3Nob3cnKTtcbn1cblxuZnVuY3Rpb24gY2xlYXJSYXRpbmdJbnB1dEVycm9yKCkge1xuICBjb25zdCByYXRpbmdJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyYXRpbmcnKTtcbiAgY29uc3QgcmF0aW5nSW5wdXRFcnJvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyYXRpbmctZXJyb3InKTtcbiAgcmF0aW5nSW5wdXQuY2xhc3NMaXN0LnJlbW92ZSgnaGFzLWVycm9yJyk7XG4gIHJhdGluZ0lucHV0LnJlbW92ZUF0dHJpYnV0ZSgnYXJpYS1pbnZhbGlkJyk7XG4gIHJhdGluZ0lucHV0LnJlbW92ZUF0dHJpYnV0ZSgnYXJpYS1kZXNjcmliZWRieScpO1xuICByYXRpbmdJbnB1dEVycm9yLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTtcbn1cblxuZnVuY3Rpb24gc2V0Q29tbWVudElucHV0RXJyb3IoKSB7XG4gIGNvbnN0IGNvbW1lbnRJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb21tZW50cycpO1xuICBjb25zdCBjb21tZW50SW5wdXRFcnJvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb21tZW50cy1lcnJvcicpO1xuICBjb21tZW50SW5wdXQuY2xhc3NMaXN0LmFkZCgnaGFzLWVycm9yJyk7XG4gIGNvbW1lbnRJbnB1dC5zZXRBdHRyaWJ1dGUoJ2FyaWEtaW52YWxpZCcsICd0cnVlJyk7XG4gIGNvbW1lbnRJbnB1dC5zZXRBdHRyaWJ1dGUoJ2FyaWEtZGVzY3JpYmVkYnknLCAnY29tbWVudHMtZXJyb3InKTtcbiAgY29tbWVudElucHV0RXJyb3IuY2xhc3NMaXN0LmFkZCgnc2hvdycpO1xufVxuXG5mdW5jdGlvbiBjbGVhckNvbW1lbnRJbnB1dEVycm9yKCkge1xuICBjb25zdCBjb21tZW50SW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWVudHMnKTtcbiAgY29uc3QgY29tbWVudElucHV0RXJyb3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWVudHMtZXJyb3InKTtcbiAgY29tbWVudElucHV0LmNsYXNzTGlzdC5yZW1vdmUoJ2hhcy1lcnJvcicpO1xuICBjb21tZW50SW5wdXQucmVtb3ZlQXR0cmlidXRlKCdhcmlhLWludmFsaWQnKTtcbiAgY29tbWVudElucHV0LnJlbW92ZUF0dHJpYnV0ZSgnYXJpYS1kZXNjcmliZWRieScpO1xuICBjb21tZW50SW5wdXRFcnJvci5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7XG59XG5cbmNvbnN0IGVycm9yRnVuY3Rpb25zID0ge1xuICBuYW1lOiB7XG4gICAgc2V0RXJyb3I6IHNldE5hbWVJbnB1dEVycm9yLFxuICAgIGNsZWFyRXJyb3I6IGNsZWFyTmFtZUlucHV0RXJyb3IsXG4gIH0sXG4gIHJhdGluZzoge1xuICAgIHNldEVycm9yOiBzZXRSYXRpbmdJbnB1dEVycm9yLFxuICAgIGNsZWFyRXJyb3I6IGNsZWFyUmF0aW5nSW5wdXRFcnJvcixcbiAgfSxcbiAgY29tbWVudHM6IHtcbiAgICBzZXRFcnJvcjogc2V0Q29tbWVudElucHV0RXJyb3IsXG4gICAgY2xlYXJFcnJvcjogY2xlYXJDb21tZW50SW5wdXRFcnJvcixcbiAgfSxcbn07XG5cbi8qKiAqKioqIHZhbGlkYXRpb24gKioqKioqICovXG5cbmZ1bmN0aW9uIHZhbGlkYXRlSW5wdXQoaWQsIHZhbHVlKSB7XG4gIGNvbnN0IGlucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpLmNsb25lTm9kZSgpO1xuICBsZXQgaW5wdXRWYWx1ZTtcbiAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICBpbnB1dFZhbHVlID0gdmFsdWU7XG4gIH0gZWxzZSB7XG4gICAgaW5wdXRWYWx1ZSA9IGlucHV0LnZhbHVlO1xuICB9XG4gIGlucHV0VmFsdWUgPSBpZCA9PT0gJ3JhdGluZycgPyBOdW1iZXIucGFyc2VJbnQoaW5wdXRWYWx1ZSwgMTApIDogaW5wdXRWYWx1ZTtcbiAgaWYgKGlucHV0VmFsdWUpIHtcbiAgICBlcnJvckZ1bmN0aW9uc1tpZF0uY2xlYXJFcnJvcigpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIGVycm9yRnVuY3Rpb25zW2lkXS5zZXRFcnJvcigpO1xuICByZXR1cm4gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlQWxsSW5wdXRzKCkge1xuICBsZXQgZXJyb3IgPSBmYWxzZTtcbiAgY29uc3QgaW5wdXRJZHMgPSBbJ25hbWUnLCAncmF0aW5nJywgJ2NvbW1lbnRzJ107XG4gIGNvbnN0IGludmFsaWRJbnB1dHMgPSBbXTtcbiAgaW5wdXRJZHMuZm9yRWFjaCgoaWQpID0+IHtcbiAgICBjb25zdCBpbnB1dFZhbGlkID0gdmFsaWRhdGVJbnB1dChpZCk7XG4gICAgaWYgKCFpbnB1dFZhbGlkKSB7XG4gICAgICBpbnZhbGlkSW5wdXRzLnB1c2goaWQpO1xuICAgICAgZXJyb3IgPSB0cnVlO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiB7IGVycm9yLCBpbnZhbGlkSW5wdXRzIH07XG59XG5cbi8qKiAqKioqIGhhbmRsZSBldmVudHMgKioqKioqICovXG5cbmZ1bmN0aW9uIGhhbmRsZVJhbmdlQ2hhbmdlKGV2ZW50KSB7XG4gIGNvbnN0IHJhdGluZ1ZhbHVlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnJhdGluZy12YWx1ZScpO1xuICByYXRpbmdWYWx1ZS5pbm5lckhUTUwgPSBgJHtldmVudC50YXJnZXQudmFsdWV9LjBgO1xuICB2YWxpZGF0ZUlucHV0KGV2ZW50LnRhcmdldC5uYW1lLCBldmVudC50YXJnZXQudmFsdWUpO1xufVxuXG5mdW5jdGlvbiBoYW5kbGVJbnB1dEtleVVwKGV2ZW50KSB7XG4gIGlmICghKGV2ZW50LmtleUNvZGUgPT09IDkpKSB7IC8vIFRhYiBrZXlcbiAgICB2YWxpZGF0ZUlucHV0KGV2ZW50LnRhcmdldC5uYW1lLCBldmVudC50YXJnZXQudmFsdWUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGhhbmRsZUlucHV0Qmx1cihldmVudCkge1xuICB2YWxpZGF0ZUlucHV0KGV2ZW50LnRhcmdldC5uYW1lLCBldmVudC50YXJnZXQudmFsdWUpO1xufVxuXG5mdW5jdGlvbiBnZXRGb3JtSW5wdXRWYWx1ZXMoKSB7XG4gIGNvbnN0IGlucHV0SWRzID0gWyduYW1lJywgJ3JhdGluZycsICdjb21tZW50cyddO1xuICBjb25zdCB2YWx1ZXMgPSB7fTtcbiAgaW5wdXRJZHMuZm9yRWFjaCgoaWQpID0+IHtcbiAgICB2YWx1ZXNbaWRdID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpLnZhbHVlO1xuICB9KTtcbiAgcmV0dXJuIHZhbHVlcztcbn1cblxuZnVuY3Rpb24gY2xlYXJGb3JtKCkge1xuICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbmFtZScpLnZhbHVlID0gJyc7XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyYXRpbmcnKS52YWx1ZSA9ICcwJztcbiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnJhdGluZy12YWx1ZScpLmlubmVySFRNTCA9ICcwLjAnO1xuICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWVudHMnKS52YWx1ZSA9ICcnO1xufVxuXG5mdW5jdGlvbiBjbGVhckZvcm1FcnJvcnMoKSB7XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduYW1lLWVycm9yJykuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpO1xuICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmF0aW5nLWVycm9yJykuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpO1xuICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWVudHMtZXJyb3InKS5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhZGQtcmV2aWV3LWZvcm0tZXJyb3InKS5jbGFzc0xpc3QucmVtb3ZlKCdzaG93Jyk7XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduYW1lJykuY2xhc3NMaXN0LnJlbW92ZSgnaGFzLWVycm9yJyk7XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyYXRpbmcnKS5jbGFzc0xpc3QucmVtb3ZlKCdoYXMtZXJyb3InKTtcbiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbW1lbnRzJykuY2xhc3NMaXN0LnJlbW92ZSgnaGFzLWVycm9yJyk7XG59XG5cbmZ1bmN0aW9uIGhhbmRsZUFkZFJldmlld1N1Ym1pdCgpIHtcbiAgY29uc3QgeyBlcnJvciwgaW52YWxpZElucHV0cyB9ID0gdmFsaWRhdGVBbGxJbnB1dHMoKTtcbiAgaWYgKCFlcnJvcikge1xuICAgIGNvbnN0IHsgbmFtZSwgcmF0aW5nLCBjb21tZW50cyB9ID0gZ2V0Rm9ybUlucHV0VmFsdWVzKCk7XG4gICAgaWYgKCghbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIpIHx8ICghbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIuY29udHJvbGxlcikpIHtcbiAgICAgIC8vIHBlcmZvcm0gcmVndWxhciBmZXRjaCBhbmQgcmVndWxhciB1cGRhdGVzXG4gICAgICBjb25zdCBzdWJtaXRCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWRkLXJldmlldy1zdWJtaXQnKTtcbiAgICAgIHN1Ym1pdEJ1dHRvbi5zZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJywgdHJ1ZSk7XG4gICAgICBzdWJtaXRCdXR0b24uc2V0QXR0cmlidXRlKCdhcmlhLWJ1c3knLCAndHJ1ZScpO1xuICAgICAgREJIZWxwZXIuYWRkUmV2aWV3KHNlbGYucmVzdGF1cmFudC5pZCwgbmFtZSwgcmF0aW5nLCBjb21tZW50cywgKGVycm9yLCBuZXdSZXZpZXcpID0+IHtcbiAgICAgICAgc3VibWl0QnV0dG9uLnJlbW92ZUF0dHJpYnV0ZSgnZGlzYWJsZWQnKTtcbiAgICAgICAgc3VibWl0QnV0dG9uLnNldEF0dHJpYnV0ZSgnYXJpYS1idXN5JywgJ2ZhbHNlJyk7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIGVucXVldWVUb2FzdCgnQW4gZXJyb3Igb2NjdXJyZWQuIFBsZWFzZSB0cnkgYWdhaW4nLCAnZXJyb3InKTtcbiAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZW5xdWV1ZVRvYXN0KGAke25hbWV9J3MgcmV2aWV3IGhhcyBiZWVuIHNhdmVkYCwgJ3N1Y2Nlc3MnKTtcbiAgICAgICAgICBjb25zdCB1bCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXZpZXdzLWxpc3QnKTtcbiAgICAgICAgICB1bC5pbnNlcnRCZWZvcmUoY3JlYXRlUmV2aWV3SFRNTChuZXdSZXZpZXcpLCB1bC5maXJzdENoaWxkKTtcbiAgICAgICAgICBjbG9zZU1vZGFsKCk7XG4gICAgICAgICAgY2xlYXJGb3JtKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCByZXF1ZXN0SWQgPSBgJHtzZWxmLnJlc3RhdXJhbnQuaWR9LSR7RGF0ZS5ub3coKX1gO1xuICAgICAgY29uc3QgbmV3UmV2aWV3ID0ge1xuICAgICAgICBuYW1lLCByYXRpbmcsIGNvbW1lbnRzLCByZXN0YXVyYW50X2lkOiBzZWxmLnJlc3RhdXJhbnQuaWQsXG4gICAgICB9O1xuICAgICAgY29uc3QgdWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmV2aWV3cy1saXN0Jyk7XG4gICAgICB1bC5pbnNlcnRCZWZvcmUoY3JlYXRlUmV2aWV3SFRNTChuZXdSZXZpZXcsIHRydWUsIHJlcXVlc3RJZCksIHVsLmZpcnN0Q2hpbGQpO1xuXG4gICAgICBpZiAoKCdvbkxpbmUnIGluIG5hdmlnYXRvcikgJiYgIW5hdmlnYXRvci5vbkxpbmUpIHtcbiAgICAgICAgZW5xdWV1ZVRvYXN0KCdZb3VyIHJldmlldyB3aWxsIGJlIHN1Ym1pdHRlZCB3aGVuIHlvdSBhcmUgYmFjayBvbmxpbmUnKTtcbiAgICAgIH1cblxuICAgICAgY2xvc2VNb2RhbCgpO1xuICAgICAgY2xlYXJGb3JtKCk7XG4gICAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5jb250cm9sbGVyLnBvc3RNZXNzYWdlKHtcbiAgICAgICAgdHlwZTogJ3Bvc3QtcmV2aWV3JyxcbiAgICAgICAgcmV2aWV3OiBuZXdSZXZpZXcsXG4gICAgICAgIHJlcXVlc3RJZCxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSBlbHNlIHsgLy8gZm9ybSBlcnJvcnMgbm90IGNsZWFyZWRcbiAgICBjb25zdCBmb3JtRXJyb3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWRkLXJldmlldy1mb3JtLWVycm9yJyk7XG4gICAgY29uc3QgZXJyb3JUZXh0ID0gYEludmFsaWQgaW5wdXQgZm9yOiAke2ludmFsaWRJbnB1dHMuam9pbignLCAnKX1gO1xuICAgIGZvcm1FcnJvci5pbm5lckhUTUwgPSBlcnJvclRleHQ7XG4gICAgZm9ybUVycm9yLmNsYXNzTGlzdC5hZGQoJ3Nob3cnKTtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpbnZhbGlkSW5wdXRzWzBdKS5mb2N1cygpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGxvZ0V2ZW50KGV2ZW50KSB7XG4gIGNvbnNvbGUubG9nKGV2ZW50LnRhcmdldC52YWx1ZSk7XG59XG4iXSwiZmlsZSI6ImFkZFJldmlld01vZGFsLmpzIn0=
