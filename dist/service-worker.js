"use strict";

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

importScripts('/js/helpers.js', 'https://cdn.jsdelivr.net/npm/idb@2.1.3/lib/idb.min.js');
var staticCacheName = 'restaurant-reviews-static-v5';
var restaurantImagesCache = 'restaurant-reviews-restaurant-images';
var mapboxTilesCache = 'restaurant-reviews-map-tiles';
var allCaches = [staticCacheName, restaurantImagesCache, mapboxTilesCache];
self.addEventListener('install', function (event) {
  event.waitUntil(caches.open(staticCacheName).then(function (cache) {
    return cache.addAll(['/', '/restaurant.html', '/css/restaurant-details.css', '/css/restaurants-list.css', '/js/helpers.js', '/js/main.js', '/js/restaurant_info.js', '/img/offline.svg', '/img/offline_wide.svg', '/img/spinner.gif', 'https://cdn.rawgit.com/jakearchibald/idb/master/lib/idb.js', 'https://use.fontawesome.com/releases/v5.5.0/css/all.css', 'https://unpkg.com/leaflet@1.3.1/dist/leaflet.css', 'https://unpkg.com/leaflet@1.3.1/dist/leaflet.js', 'https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700', 'https://unpkg.com/leaflet@1.3.1/dist/images/marker-icon.png', 'https://unpkg.com/leaflet@1.3.1/dist/images/marker-icon-2x.png', 'https://unpkg.com/leaflet@1.3.1/dist/images/marker-shadow.png']);
  }).catch(function (error) {
    return console.log(error);
  }));
});
self.addEventListener('activate', function (event) {
  // delete the old versions of the cache
  event.waitUntil(caches.keys().then(function (cacheNames) {
    return Promise.all(cacheNames.filter(function (cacheName) {
      return cacheName.startsWith('restaurant-reviews-') && !allCaches.includes(cacheName);
    }).map(function (cacheName) {
      return caches.delete(cacheName);
    }));
  }).catch(function (error) {
    return console.log(error);
  }));
  self.clients.claim();
});
var dbPromise = openDatabase(true);
self.addEventListener('message', function (event) {
  if (event.data.type === 'post-review') {
    var _event$data = event.data,
        review = _event$data.review,
        requestId = _event$data.requestId;
    dbPromise.then(function (db) {
      var outboxStore = db.transaction('outbox', 'readwrite').objectStore('outbox');
      outboxStore.put(_objectSpread({}, review, {
        request_id: requestId
      }));
      self.registration.sync.register(requestId);
    });
  }
});
self.addEventListener('sync', function (event) {
  event.waitUntil(dbPromise.then(function (db) {
    var requestId = event.tag;
    var outboxStore = db.transaction('outbox').objectStore('outbox');
    outboxStore.get(requestId).then(function (request) {
      var restaurant_id = request.restaurant_id,
          name = request.name,
          rating = request.rating,
          comments = request.comments;
      return DBHelper.addReview(restaurant_id, name, rating, comments, function (error, newReview) {
        if (error) {
          // broadcast update to all clients
          self.clients.matchAll().then(function (clients) {
            clients.forEach(function (client) {
              client.postMessage({
                type: 'update-review',
                error: true,
                requestId: requestId
              });
            });
          }); // delete review from outbox store

          outboxStore = db.transaction('outbox', 'readwrite').objectStore('outbox');
          outboxStore.delete(requestId);
        } else {
          // broadcast update to all clients
          self.clients.matchAll().then(function (clients) {
            clients.forEach(function (client) {
              client.postMessage({
                type: 'update-review',
                review: newReview,
                requestId: requestId
              });
            });
          }); // add review to reviews store

          var reviewsStore = db.transaction('reviews', 'readwrite').objectStore('reviews');
          reviewsStore.put(newReview); // delete review from outbox store

          outboxStore = db.transaction('outbox', 'readwrite').objectStore('outbox');
          outboxStore.delete(requestId);
        }
      });
    });
  }));
});
self.addEventListener('fetch', function (event) {
  var requestUrl = new URL(event.request.url);

  if (requestUrl.origin === location.origin) {
    var restaurantImagePathRegex = /img\/[0-9_\-a-zA-Z]+\.jpg/;

    if (restaurantImagePathRegex.test(requestUrl.pathname)) {
      event.respondWith(serveRestaurantImage(event.request));
      return;
    } // cache should match index.html to /


    if (requestUrl.pathname.startsWith('/index.html')) {
      event.respondWith(caches.match('/').then(function (response) {
        return response || fetch(event.request);
      }));
      return;
    }
  } else if (requestUrl.origin === 'https://api.tiles.mapbox.com') {
    event.respondWith(serveMapboxTiles(event.request));
    return;
  }

  event.respondWith(caches.match(event.request, {
    ignoreSearch: true
  }) // ignore search for /restaurant.html?id=X
  .then(function (response) {
    return response || fetch(event.request);
  }));
});

var serveRestaurantImage = function serveRestaurantImage(request) {
  // image urls have multiple - and _ for orientation, crop, pixel density and screen size
  // the relevant part of the url is before the first -
  var storageUrl = request.url.split('-')[0];
  return caches.open(restaurantImagesCache).then(function (cache) {
    return cache.match(storageUrl).then(function (response) {
      if (response) return response;
      return fetch(request).then(function (networkResponse) {
        cache.put(storageUrl, networkResponse.clone());
        return networkResponse;
      }).catch(function (error) {
        console.log(error); // use of offline images inspired by Salah Hamza's stage 1 project
        // Available at https://github.com/SalahHamza/mws-restaurant-stage-1/blob/master/sw.js

        if (request.url.includes('wide')) return caches.match('/img/offline_wide.svg');
        return caches.match('/img/offline.svg');
      });
    });
  });
};

var serveMapboxTiles = function serveMapboxTiles(request) {
  return caches.open(mapboxTilesCache).then(function (cache) {
    return cache.match(request.url).then(function (response) {
      if (response) return response; // if request isn't cached, cache it when fetch response is returned

      return fetch(request).then(function (networkResponse) {
        cache.put(request.url, networkResponse.clone());
        return networkResponse;
      });
    });
  });
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2Utd29ya2VyLmpzIl0sIm5hbWVzIjpbImltcG9ydFNjcmlwdHMiLCJzdGF0aWNDYWNoZU5hbWUiLCJyZXN0YXVyYW50SW1hZ2VzQ2FjaGUiLCJtYXBib3hUaWxlc0NhY2hlIiwiYWxsQ2FjaGVzIiwic2VsZiIsImFkZEV2ZW50TGlzdGVuZXIiLCJldmVudCIsIndhaXRVbnRpbCIsImNhY2hlcyIsIm9wZW4iLCJ0aGVuIiwiY2FjaGUiLCJhZGRBbGwiLCJjYXRjaCIsImVycm9yIiwiY29uc29sZSIsImxvZyIsImtleXMiLCJjYWNoZU5hbWVzIiwiUHJvbWlzZSIsImFsbCIsImZpbHRlciIsImNhY2hlTmFtZSIsInN0YXJ0c1dpdGgiLCJpbmNsdWRlcyIsIm1hcCIsImRlbGV0ZSIsImNsaWVudHMiLCJjbGFpbSIsImRiUHJvbWlzZSIsIm9wZW5EYXRhYmFzZSIsImRhdGEiLCJ0eXBlIiwicmV2aWV3IiwicmVxdWVzdElkIiwiZGIiLCJvdXRib3hTdG9yZSIsInRyYW5zYWN0aW9uIiwib2JqZWN0U3RvcmUiLCJwdXQiLCJyZXF1ZXN0X2lkIiwicmVnaXN0cmF0aW9uIiwic3luYyIsInJlZ2lzdGVyIiwidGFnIiwiZ2V0IiwicmVxdWVzdCIsInJlc3RhdXJhbnRfaWQiLCJuYW1lIiwicmF0aW5nIiwiY29tbWVudHMiLCJEQkhlbHBlciIsImFkZFJldmlldyIsIm5ld1JldmlldyIsIm1hdGNoQWxsIiwiZm9yRWFjaCIsImNsaWVudCIsInBvc3RNZXNzYWdlIiwicmV2aWV3c1N0b3JlIiwicmVxdWVzdFVybCIsIlVSTCIsInVybCIsIm9yaWdpbiIsImxvY2F0aW9uIiwicmVzdGF1cmFudEltYWdlUGF0aFJlZ2V4IiwidGVzdCIsInBhdGhuYW1lIiwicmVzcG9uZFdpdGgiLCJzZXJ2ZVJlc3RhdXJhbnRJbWFnZSIsIm1hdGNoIiwicmVzcG9uc2UiLCJmZXRjaCIsInNlcnZlTWFwYm94VGlsZXMiLCJpZ25vcmVTZWFyY2giLCJzdG9yYWdlVXJsIiwic3Bs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QUFBQSxHQURBLENBQVA7QUFnQkQsQ0FyQkQ7O0FBdUJBLElBQU1HLGdCQUFnQixHQUFHLFNBQW5CQSxnQkFBbUIsQ0FBQTFCLE9BQU87QUFBQSxTQUFJdEMsTUFBTSxDQUFDQyxJQUFQLENBQVlQLGdCQUFaLEVBQThCUSxJQUE5QixDQUNsQyxVQUFBQyxLQUFLO0FBQUEsV0FBSUEsS0FBSyxDQUFDMEQsS0FBTixDQUFZdkIsT0FBTyxDQUFDZSxHQUFwQixFQUF5Qm5ELElBQXpCLENBQThCLFVBQUM0RCxRQUFELEVBQWM7QUFDbkQsVUFBSUEsUUFBSixFQUFjLE9BQU9BLFFBQVAsQ0FEcUMsQ0FHbkQ7O0FBQ0EsYUFBT0MsS0FBSyxDQUFDekIsT0FBRCxDQUFMLENBQWVwQyxJQUFmLENBQW9CLFVBQUNrRSxlQUFELEVBQXFCO0FBQzlDakUsUUFBQUEsS0FBSyxDQUFDNEIsR0FBTixDQUFVTyxPQUFPLENBQUNlLEdBQWxCLEVBQXVCZSxlQUFlLENBQUNDLEtBQWhCLEVBQXZCO0FBQ0EsZUFBT0QsZUFBUDtBQUNELE9BSE0sQ0FBUDtBQUlELEtBUlEsQ0FBSjtBQUFBLEdBRDZCLENBQUo7QUFBQSxDQUFoQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydFNjcmlwdHMoJy9qcy9oZWxwZXJzLmpzJywgJ2h0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vaWRiQDIuMS4zL2xpYi9pZGIubWluLmpzJyk7XG5cbmNvbnN0IHN0YXRpY0NhY2hlTmFtZSA9ICdyZXN0YXVyYW50LXJldmlld3Mtc3RhdGljLXY1JztcbmNvbnN0IHJlc3RhdXJhbnRJbWFnZXNDYWNoZSA9ICdyZXN0YXVyYW50LXJldmlld3MtcmVzdGF1cmFudC1pbWFnZXMnO1xuY29uc3QgbWFwYm94VGlsZXNDYWNoZSA9ICdyZXN0YXVyYW50LXJldmlld3MtbWFwLXRpbGVzJztcbmNvbnN0IGFsbENhY2hlcyA9IFtcbiAgc3RhdGljQ2FjaGVOYW1lLFxuICByZXN0YXVyYW50SW1hZ2VzQ2FjaGUsXG4gIG1hcGJveFRpbGVzQ2FjaGUsXG5dO1xuXG5zZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2luc3RhbGwnLCAoZXZlbnQpID0+IHtcbiAgZXZlbnQud2FpdFVudGlsKFxuICAgIGNhY2hlcy5vcGVuKHN0YXRpY0NhY2hlTmFtZSkudGhlbihjYWNoZSA9PiBjYWNoZS5hZGRBbGwoW1xuICAgICAgJy8nLFxuICAgICAgJy9yZXN0YXVyYW50Lmh0bWwnLFxuICAgICAgJy9jc3MvcmVzdGF1cmFudC1kZXRhaWxzLmNzcycsXG4gICAgICAnL2Nzcy9yZXN0YXVyYW50cy1saXN0LmNzcycsXG4gICAgICAnL2pzL2hlbHBlcnMuanMnLFxuICAgICAgJy9qcy9tYWluLmpzJyxcbiAgICAgICcvanMvcmVzdGF1cmFudF9pbmZvLmpzJyxcbiAgICAgICcvaW1nL29mZmxpbmUuc3ZnJyxcbiAgICAgICcvaW1nL29mZmxpbmVfd2lkZS5zdmcnLFxuICAgICAgJy9pbWcvc3Bpbm5lci5naWYnLFxuICAgICAgJ2h0dHBzOi8vY2RuLnJhd2dpdC5jb20vamFrZWFyY2hpYmFsZC9pZGIvbWFzdGVyL2xpYi9pZGIuanMnLFxuICAgICAgJ2h0dHBzOi8vdXNlLmZvbnRhd2Vzb21lLmNvbS9yZWxlYXNlcy92NS41LjAvY3NzL2FsbC5jc3MnLFxuICAgICAgJ2h0dHBzOi8vdW5wa2cuY29tL2xlYWZsZXRAMS4zLjEvZGlzdC9sZWFmbGV0LmNzcycsXG4gICAgICAnaHR0cHM6Ly91bnBrZy5jb20vbGVhZmxldEAxLjMuMS9kaXN0L2xlYWZsZXQuanMnLFxuICAgICAgJ2h0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzP2ZhbWlseT1Tb3VyY2UrU2FucytQcm86MjAwLDMwMCw0MDAsNjAwLDcwMCcsXG4gICAgICAnaHR0cHM6Ly91bnBrZy5jb20vbGVhZmxldEAxLjMuMS9kaXN0L2ltYWdlcy9tYXJrZXItaWNvbi5wbmcnLFxuICAgICAgJ2h0dHBzOi8vdW5wa2cuY29tL2xlYWZsZXRAMS4zLjEvZGlzdC9pbWFnZXMvbWFya2VyLWljb24tMngucG5nJyxcbiAgICAgICdodHRwczovL3VucGtnLmNvbS9sZWFmbGV0QDEuMy4xL2Rpc3QvaW1hZ2VzL21hcmtlci1zaGFkb3cucG5nJyxcbiAgICBdKSkuY2F0Y2goZXJyb3IgPT4gY29uc29sZS5sb2coZXJyb3IpKSxcbiAgKTtcbn0pO1xuXG5zZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2FjdGl2YXRlJywgKGV2ZW50KSA9PiB7XG4gIC8vIGRlbGV0ZSB0aGUgb2xkIHZlcnNpb25zIG9mIHRoZSBjYWNoZVxuICBldmVudC53YWl0VW50aWwoXG4gICAgY2FjaGVzLmtleXMoKS50aGVuKGNhY2hlTmFtZXMgPT4gUHJvbWlzZS5hbGwoXG4gICAgICBjYWNoZU5hbWVzLmZpbHRlcihjYWNoZU5hbWUgPT4gKFxuICAgICAgICBjYWNoZU5hbWUuc3RhcnRzV2l0aCgncmVzdGF1cmFudC1yZXZpZXdzLScpICYmICFhbGxDYWNoZXMuaW5jbHVkZXMoY2FjaGVOYW1lKVxuICAgICAgKSkubWFwKGNhY2hlTmFtZSA9PiBjYWNoZXMuZGVsZXRlKGNhY2hlTmFtZSkpLFxuICAgICkpLmNhdGNoKGVycm9yID0+IGNvbnNvbGUubG9nKGVycm9yKSksXG4gICk7XG5cbiAgc2VsZi5jbGllbnRzLmNsYWltKCk7XG59KTtcblxuY29uc3QgZGJQcm9taXNlID0gb3BlbkRhdGFiYXNlKHRydWUpO1xuXG5zZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCAoZXZlbnQpID0+IHtcbiAgaWYgKGV2ZW50LmRhdGEudHlwZSA9PT0gJ3Bvc3QtcmV2aWV3Jykge1xuICAgIGNvbnN0IHsgcmV2aWV3LCByZXF1ZXN0SWQgfSA9IGV2ZW50LmRhdGE7XG4gICAgZGJQcm9taXNlLnRoZW4oKGRiKSA9PiB7XG4gICAgICBjb25zdCBvdXRib3hTdG9yZSA9IGRiLnRyYW5zYWN0aW9uKCdvdXRib3gnLCAncmVhZHdyaXRlJykub2JqZWN0U3RvcmUoJ291dGJveCcpO1xuICAgICAgb3V0Ym94U3RvcmUucHV0KHsgLi4ucmV2aWV3LCByZXF1ZXN0X2lkOiByZXF1ZXN0SWQgfSk7XG4gICAgICBzZWxmLnJlZ2lzdHJhdGlvbi5zeW5jLnJlZ2lzdGVyKHJlcXVlc3RJZCk7XG4gICAgfSk7XG4gIH1cbn0pO1xuXG5zZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ3N5bmMnLCBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgZXZlbnQud2FpdFVudGlsKFxuICAgIGRiUHJvbWlzZS50aGVuKChkYikgPT4ge1xuICAgICAgY29uc3QgcmVxdWVzdElkID0gZXZlbnQudGFnO1xuICAgICAgbGV0IG91dGJveFN0b3JlID0gZGIudHJhbnNhY3Rpb24oJ291dGJveCcpLm9iamVjdFN0b3JlKCdvdXRib3gnKTtcbiAgICAgIG91dGJveFN0b3JlLmdldChyZXF1ZXN0SWQpLnRoZW4oKHJlcXVlc3QpID0+IHtcbiAgICAgICAgY29uc3QgeyByZXN0YXVyYW50X2lkLCBuYW1lLCByYXRpbmcsIGNvbW1lbnRzIH0gPSByZXF1ZXN0O1xuICAgICAgICByZXR1cm4gREJIZWxwZXIuYWRkUmV2aWV3KHJlc3RhdXJhbnRfaWQsIG5hbWUsIHJhdGluZywgY29tbWVudHMsIChlcnJvciwgbmV3UmV2aWV3KSA9PiB7XG4gICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAvLyBicm9hZGNhc3QgdXBkYXRlIHRvIGFsbCBjbGllbnRzXG4gICAgICAgICAgICBzZWxmLmNsaWVudHMubWF0Y2hBbGwoKS50aGVuKChjbGllbnRzKSA9PiB7XG4gICAgICAgICAgICAgIGNsaWVudHMuZm9yRWFjaCgoY2xpZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICBjbGllbnQucG9zdE1lc3NhZ2Uoe1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAndXBkYXRlLXJldmlldycsXG4gICAgICAgICAgICAgICAgICAgIGVycm9yOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vIGRlbGV0ZSByZXZpZXcgZnJvbSBvdXRib3ggc3RvcmVcbiAgICAgICAgICAgIG91dGJveFN0b3JlID0gZGIudHJhbnNhY3Rpb24oJ291dGJveCcsICdyZWFkd3JpdGUnKS5vYmplY3RTdG9yZSgnb3V0Ym94Jyk7XG4gICAgICAgICAgICBvdXRib3hTdG9yZS5kZWxldGUocmVxdWVzdElkKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gYnJvYWRjYXN0IHVwZGF0ZSB0byBhbGwgY2xpZW50c1xuICAgICAgICAgICAgc2VsZi5jbGllbnRzLm1hdGNoQWxsKCkudGhlbigoY2xpZW50cykgPT4ge1xuICAgICAgICAgICAgICBjbGllbnRzLmZvckVhY2goKGNsaWVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgY2xpZW50LnBvc3RNZXNzYWdlKHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3VwZGF0ZS1yZXZpZXcnLFxuICAgICAgICAgICAgICAgICAgICByZXZpZXc6IG5ld1JldmlldyxcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvLyBhZGQgcmV2aWV3IHRvIHJldmlld3Mgc3RvcmVcbiAgICAgICAgICAgIGNvbnN0IHJldmlld3NTdG9yZSA9IGRiLnRyYW5zYWN0aW9uKCdyZXZpZXdzJywgJ3JlYWR3cml0ZScpLm9iamVjdFN0b3JlKCdyZXZpZXdzJyk7XG4gICAgICAgICAgICByZXZpZXdzU3RvcmUucHV0KG5ld1Jldmlldyk7XG4gICAgICAgICAgICAvLyBkZWxldGUgcmV2aWV3IGZyb20gb3V0Ym94IHN0b3JlXG4gICAgICAgICAgICBvdXRib3hTdG9yZSA9IGRiLnRyYW5zYWN0aW9uKCdvdXRib3gnLCAncmVhZHdyaXRlJykub2JqZWN0U3RvcmUoJ291dGJveCcpO1xuICAgICAgICAgICAgb3V0Ym94U3RvcmUuZGVsZXRlKHJlcXVlc3RJZCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9KVxuICApO1xufSk7XG5cbnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCAoZXZlbnQpID0+IHtcbiAgY29uc3QgcmVxdWVzdFVybCA9IG5ldyBVUkwoZXZlbnQucmVxdWVzdC51cmwpO1xuXG4gIGlmIChyZXF1ZXN0VXJsLm9yaWdpbiA9PT0gbG9jYXRpb24ub3JpZ2luKSB7XG4gICAgY29uc3QgcmVzdGF1cmFudEltYWdlUGF0aFJlZ2V4ID0gL2ltZ1xcL1swLTlfXFwtYS16QS1aXStcXC5qcGcvO1xuICAgIGlmIChyZXN0YXVyYW50SW1hZ2VQYXRoUmVnZXgudGVzdChyZXF1ZXN0VXJsLnBhdGhuYW1lKSkge1xuICAgICAgZXZlbnQucmVzcG9uZFdpdGgoc2VydmVSZXN0YXVyYW50SW1hZ2UoZXZlbnQucmVxdWVzdCkpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGNhY2hlIHNob3VsZCBtYXRjaCBpbmRleC5odG1sIHRvIC9cbiAgICBpZiAocmVxdWVzdFVybC5wYXRobmFtZS5zdGFydHNXaXRoKCcvaW5kZXguaHRtbCcpKSB7XG4gICAgICBldmVudC5yZXNwb25kV2l0aChjYWNoZXMubWF0Y2goJy8nKVxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiByZXNwb25zZSB8fCBmZXRjaChldmVudC5yZXF1ZXN0KSkpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfSBlbHNlIGlmIChyZXF1ZXN0VXJsLm9yaWdpbiA9PT0gJ2h0dHBzOi8vYXBpLnRpbGVzLm1hcGJveC5jb20nKSB7XG4gICAgZXZlbnQucmVzcG9uZFdpdGgoc2VydmVNYXBib3hUaWxlcyhldmVudC5yZXF1ZXN0KSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgZXZlbnQucmVzcG9uZFdpdGgoXG4gICAgY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QsIHsgaWdub3JlU2VhcmNoOiB0cnVlIH0pIC8vIGlnbm9yZSBzZWFyY2ggZm9yIC9yZXN0YXVyYW50Lmh0bWw/aWQ9WFxuICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gcmVzcG9uc2UgfHwgZmV0Y2goZXZlbnQucmVxdWVzdCkpLFxuICApO1xufSk7XG5cbmNvbnN0IHNlcnZlUmVzdGF1cmFudEltYWdlID0gKHJlcXVlc3QpID0+IHtcbiAgLy8gaW1hZ2UgdXJscyBoYXZlIG11bHRpcGxlIC0gYW5kIF8gZm9yIG9yaWVudGF0aW9uLCBjcm9wLCBwaXhlbCBkZW5zaXR5IGFuZCBzY3JlZW4gc2l6ZVxuICAvLyB0aGUgcmVsZXZhbnQgcGFydCBvZiB0aGUgdXJsIGlzIGJlZm9yZSB0aGUgZmlyc3QgLVxuICBjb25zdCBzdG9yYWdlVXJsID0gcmVxdWVzdC51cmwuc3BsaXQoJy0nKVswXTtcblxuICByZXR1cm4gY2FjaGVzLm9wZW4ocmVzdGF1cmFudEltYWdlc0NhY2hlKS50aGVuKFxuICAgIGNhY2hlID0+IGNhY2hlLm1hdGNoKHN0b3JhZ2VVcmwpLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICBpZiAocmVzcG9uc2UpIHJldHVybiByZXNwb25zZTtcblxuICAgICAgcmV0dXJuIGZldGNoKHJlcXVlc3QpLnRoZW4oKG5ldHdvcmtSZXNwb25zZSkgPT4ge1xuICAgICAgICBjYWNoZS5wdXQoc3RvcmFnZVVybCwgbmV0d29ya1Jlc3BvbnNlLmNsb25lKCkpO1xuICAgICAgICByZXR1cm4gbmV0d29ya1Jlc3BvbnNlO1xuICAgICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcbiAgICAgICAgLy8gdXNlIG9mIG9mZmxpbmUgaW1hZ2VzIGluc3BpcmVkIGJ5IFNhbGFoIEhhbXphJ3Mgc3RhZ2UgMSBwcm9qZWN0XG4gICAgICAgIC8vIEF2YWlsYWJsZSBhdCBodHRwczovL2dpdGh1Yi5jb20vU2FsYWhIYW16YS9td3MtcmVzdGF1cmFudC1zdGFnZS0xL2Jsb2IvbWFzdGVyL3N3LmpzXG4gICAgICAgIGlmIChyZXF1ZXN0LnVybC5pbmNsdWRlcygnd2lkZScpKSByZXR1cm4gY2FjaGVzLm1hdGNoKCcvaW1nL29mZmxpbmVfd2lkZS5zdmcnKTtcbiAgICAgICAgcmV0dXJuIGNhY2hlcy5tYXRjaCgnL2ltZy9vZmZsaW5lLnN2ZycpO1xuICAgICAgfSk7XG4gICAgfSksXG4gICk7XG59O1xuXG5jb25zdCBzZXJ2ZU1hcGJveFRpbGVzID0gcmVxdWVzdCA9PiBjYWNoZXMub3BlbihtYXBib3hUaWxlc0NhY2hlKS50aGVuKFxuICBjYWNoZSA9PiBjYWNoZS5tYXRjaChyZXF1ZXN0LnVybCkudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICBpZiAocmVzcG9uc2UpIHJldHVybiByZXNwb25zZTtcblxuICAgIC8vIGlmIHJlcXVlc3QgaXNuJ3QgY2FjaGVkLCBjYWNoZSBpdCB3aGVuIGZldGNoIHJlc3BvbnNlIGlzIHJldHVybmVkXG4gICAgcmV0dXJuIGZldGNoKHJlcXVlc3QpLnRoZW4oKG5ldHdvcmtSZXNwb25zZSkgPT4ge1xuICAgICAgY2FjaGUucHV0KHJlcXVlc3QudXJsLCBuZXR3b3JrUmVzcG9uc2UuY2xvbmUoKSk7XG4gICAgICByZXR1cm4gbmV0d29ya1Jlc3BvbnNlO1xuICAgIH0pO1xuICB9KSxcbik7XG4iXSwiZmlsZSI6InNlcnZpY2Utd29ya2VyLmpzIn0=
